---
import BaseLayout from "../layouts/BaseLayout.astro";

// === SIMULACI√ìN DE DATOS DE CONTENTFUL ===
// As√≠ se ver√≠a la respuesta de tu API.
// Sugerencia de Modelo en Contentful (Content Type: 'promocion'):
// - titulo (Short text)
// - descripcion (Long text)
// - imagen (Media)
// - fechaFin (Date and time) -> ¬°Aqu√≠ controlas el Timer! ‚è∞
// - tipo (Short text / Dropdown)
// - destacado (Boolean)

const responseContentful = [
  {
    sys: { id: "1" },
    fields: {
      titulo: "iPhone 15 Pro - Doble de Gigas",
      descripcion: "Ll√©vatelo en Plan Telcel Plus 5 con el doble de gigas por todo el contrato. ¬°Solo por tiempo limitado!",
      imagen: {
        fields: {
          file: {
            url: "https://images.unsplash.com/photo-1696446701796-da61225697cc?q=80&w=2070&auto=format&fit=crop"
          }
        }
      },
      fechaFin: new Date(new Date().getTime() + 48 * 60 * 60 * 1000).toISOString(), // 48 horas restantes
      tipo: "Equipos",
      destacado: true, // Esta ir√° al Hero
    }
  },
  {
    sys: { id: "2" },
    fields: {
      titulo: "Internet en Casa 50Mbps",
      descripcion: "Contrata hoy y recibe instalaci√≥n express gratuita + 1 mes de Amazon Prime.",
      imagen: {
        fields: {
          file: {
            url: "https://images.unsplash.com/photo-1544197150-b99a580bb7a8?q=80&w=2070&auto=format&fit=crop"
          }
        }
      },
      fechaFin: new Date(new Date().getTime() + 5 * 24 * 60 * 60 * 1000).toISOString(), // 5 d√≠as
      tipo: "Internet",
      destacado: false,
    }
  },
  {
    sys: { id: "3" },
    fields: {
      titulo: "Renueva y Ahorra",
      descripcion: "Bono de $1,000 en equipos Samsung al renovar tu plan actual antes del d√≠a 30.",
      imagen: {
        fields: {
          file: {
            url: "https://images.unsplash.com/photo-1610945265078-38584e106955?q=80&w=2070&auto=format&fit=crop"
          }
        }
      },
      fechaFin: null, // Sin timer (Promo permanente o hasta agotar existencias)
      tipo: "Renovaci√≥n",
      destacado: false,
    }
  },
  {
    sys: { id: "4" },
    fields: {
      titulo: "C√°mbiate a Telcel",
      descripcion: "¬øVienes de otra compa√±√≠a? Conserva tu n√∫mero y recibe Gigas adicionales por 6 meses al hacer tu portabilidad.",
      imagen: {
        fields: {
          file: {
            url: "https://images.unsplash.com/photo-1534536281715-e28d76689b4d?q=80&w=2073&auto=format&fit=crop"
          }
        }
      },
      fechaFin: null,
      tipo: "Portabilidad",
      destacado: false,
    }
  }
];

// Separamos la promo destacada del resto para el dise√±o
const heroPromo = responseContentful.find(p => p.fields.destacado);
const gridPromos = responseContentful.filter(p => !p.fields.destacado);
---

<BaseLayout
  title="Promociones Exclusivas | L√≠nea Digital"
  description="Ofertas por tiempo limitado en equipos y planes Telcel."
>
  
  <!-- === 1. HERO SECTION (La Promo Estrella) === -->
  {heroPromo && (
    <section class="relative bg-slate-900 overflow-hidden min-h-[600px] flex items-center">
      <!-- Imagen de Fondo con Overlay -->
      <div class="absolute inset-0 z-0">
        <img 
          src={heroPromo.fields.imagen.fields.file.url} 
          alt={heroPromo.fields.titulo}
          class="w-full h-full object-cover opacity-60"
        />
        <div class="absolute inset-0 bg-gradient-to-r from-slate-900 via-slate-900/80 to-transparent"></div>
      </div>

      <div class="container mx-auto px-4 relative z-10 py-20">
        <div class="max-w-2xl">
          <span class="inline-block px-4 py-1.5 rounded-full bg-red-600 text-white text-sm font-bold mb-6 animate-pulse">
            üî• Oferta Rel√°mpago
          </span>
          <h1 class="text-5xl md:text-7xl font-bold text-white mb-6 leading-tight">
            {heroPromo.fields.titulo}
          </h1>
          <p class="text-xl text-slate-200 mb-8 leading-relaxed">
            {heroPromo.fields.descripcion}
          </p>

          <!-- TIMER GIGANTE -->
          {heroPromo.fields.fechaFin && (
            <div class="mb-10 p-6 bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl inline-block">
              <p class="text-sm text-slate-300 uppercase tracking-widest mb-2 font-bold">Esta oferta termina en:</p>
              <div class="promo-countdown text-4xl md:text-5xl font-mono font-bold text-white tracking-tight" data-ends={heroPromo.fields.fechaFin}>
                Cargando...
              </div>
            </div>
          )}

          <div class="flex flex-col sm:flex-row gap-4">
            <a 
              href={`https://wa.me/529616189200?text=¬°Lo quiero! Me interesa la promo destacada: ${heroPromo.fields.titulo}`}
              target="_blank"
              class="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold rounded-xl transition-all shadow-lg shadow-blue-600/30 flex items-center justify-center gap-2"
            >
              <span>Apartar Ahora</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
            </a>
            <button 
              class="share-btn px-8 py-4 bg-white/10 hover:bg-white/20 text-white text-lg font-bold rounded-xl border border-white/20 transition-all flex items-center justify-center gap-2"
              data-title={heroPromo.fields.titulo}
              data-text={heroPromo.fields.descripcion}
            >
              Compartir
            </button>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- === 2. GRID DE OFERTAS (El resto) === -->
  <section class="py-20 bg-slate-50 dark:bg-slate-950">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between mb-12">
        <h2 class="text-3xl font-bold text-slate-900 dark:text-white">M√°s Promociones</h2>
        <span class="text-slate-500 dark:text-slate-400 text-sm">{gridPromos.length} ofertas disponibles</span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {gridPromos.map((promo, index) => (
          <article class="group bg-white dark:bg-slate-900 rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-slate-200 dark:border-slate-800 flex flex-col">
            <!-- Imagen -->
            <div class="relative h-56 overflow-hidden">
              <div class="absolute top-4 left-4 z-10">
                <span class="px-3 py-1 bg-white/90 dark:bg-slate-950/90 backdrop-blur rounded-lg text-xs font-bold text-slate-700 dark:text-slate-200">
                  {promo.fields.tipo}
                </span>
              </div>
              <img 
                src={promo.fields.imagen.fields.file.url} 
                alt={promo.fields.titulo}
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
              />
            </div>

            <!-- Contenido -->
            <div class="p-6 flex flex-col flex-1">
              <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2 group-hover:text-blue-600 transition-colors">
                {promo.fields.titulo}
              </h3>
              <p class="text-slate-600 dark:text-slate-400 text-sm mb-4 flex-1">
                {promo.fields.descripcion}
              </p>

              {/* Timer Peque√±o */}
              {promo.fields.fechaFin && (
                <div class="mb-4 flex items-center gap-2 text-red-600 dark:text-red-400 text-xs font-bold bg-red-50 dark:bg-red-900/20 p-2 rounded-lg w-fit">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  <span class="promo-countdown" data-ends={promo.fields.fechaFin}>Calculando...</span>
                </div>
              )}

              <div class="pt-4 border-t border-slate-100 dark:border-slate-800 flex gap-3">
                <a 
                  href={`https://wa.me/529616189200?text=Info sobre: ${promo.fields.titulo}`}
                  target="_blank"
                  class="flex-1 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg text-center transition-colors"
                >
                  Me interesa
                </a>
                <button 
                  class="share-btn p-2.5 text-slate-500 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-slate-800 rounded-lg transition-colors"
                  data-title={promo.fields.titulo}
                  data-text={promo.fields.descripcion}
                  aria-label="Compartir"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                </button>
              </div>
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>

</BaseLayout>

<script>
  // === L√≥gica de Timers ===
  function updateCountdowns() {
    const countdowns = document.querySelectorAll('.promo-countdown');
    const now = new Date().getTime();
    
    countdowns.forEach(el => {
      const endDate = new Date(el.getAttribute('data-ends') || '').getTime();
      const diff = endDate - now;
      
      if (diff <= 0) {
        el.textContent = "Finalizada";
        el.classList.add('opacity-50');
        return;
      }
      
      const d = Math.floor(diff / (1000 * 60 * 60 * 24));
      const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const s = Math.floor((diff % (1000 * 60)) / 1000);
      
      // Formato diferente seg√∫n si es el timer grande o peque√±o
      if (el.classList.contains('text-4xl')) {
        el.textContent = `${d}d : ${h.toString().padStart(2,'0')}h : ${m.toString().padStart(2,'0')}m : ${s.toString().padStart(2,'0')}s`;
      } else {
        el.textContent = `${d}d ${h}h ${m}m`;
      }
    });
  }
  
  setInterval(updateCountdowns, 1000);
  updateCountdowns();

  // === L√≥gica Compartir ===
  document.querySelectorAll('.share-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const data = {
        title: btn.getAttribute('data-title') || 'Promoci√≥n',
        text: btn.getAttribute('data-text') || '',
        url: window.location.href
      };
      if (navigator.share) {
        try { await navigator.share(data); } catch (e) {}
      } else {
        // Fallback simple
        alert('Copia este enlace: ' + data.url);
      }
    });
  });
</script>
