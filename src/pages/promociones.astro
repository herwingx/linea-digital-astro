---
import BaseLayout from "../layouts/BaseLayout.astro";
import Button from "../components/ui/Button.astro";

// === SIMULACIÓN DE DATOS DE CONTENTFUL ===
const responseContentful = [
  {
    sys: { id: "1" },
    fields: {
      titulo: "iPhone 15 Pro",
      descripcion: "La potencia definitiva en tus manos. Contrátalo en Plan Telcel Plus 5 con doble de gigas x12 meses.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1696446701796-da61225697cc?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: new Date(new Date().getTime() + 48 * 60 * 60 * 1000).toISOString(),
      tipo: "Equipos Premium",
      destacado: true,
    }
  },
  {
    sys: { id: "2" },
    fields: {
      titulo: "Internet Casa 50 Megas",
      descripcion: "Olvídate de los cables. Conéctate al instante y recibe 1 mes de Prime Video de regalo.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1544197150-b99a580bb7a8?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: new Date(new Date().getTime() + 5 * 24 * 60 * 60 * 1000).toISOString(),
      tipo: "Hogar",
      destacado: false,
    }
  },
  {
    sys: { id: "3" },
    fields: {
      titulo: "Renueva tu Samsung",
      descripcion: "Bono de $2,000 en la Serie S24 al renovar tu plan actual antes de fin de mes.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1610945415295-d9bbf067e59c?q=80&w=2071&auto=format&fit=crop" } } },
      fechaFin: null,
      tipo: "Renovación",
      destacado: false,
    }
  },
  {
    sys: { id: "4" },
    fields: {
      titulo: "Galaxy S24 Ultra",
      descripcion: "El smartphone más avanzado de Samsung. Incluye Galaxy Buds2 Pro de regalo en planes Plus.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1610945415295-d9bbf067e59c?q=80&w=2071&auto=format&fit=crop" } } },
      fechaFin: new Date(new Date().getTime() + 72 * 60 * 60 * 1000).toISOString(),
      tipo: "Equipos Premium",
      destacado: true,
    }
  },
  {
    sys: { id: "5" },
    fields: {
      titulo: "Plan Familiar Telcel",
      descripcion: "4 líneas con 20GB cada una. Llamadas ilimitadas y redes sociales sin límite.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1511988617509-a57c8a288659?q=80&w=2071&auto=format&fit=crop" } } },
      fechaFin: new Date(new Date().getTime() + 120 * 60 * 60 * 1000).toISOString(),
      tipo: "Planes",
      destacado: true,
    }
  },
  {
    sys: { id: "6" },
    fields: {
      titulo: "Plan Familiar Telcel",
      descripcion: "4 líneas con 20GB cada una. Llamadas ilimitadas y redes sociales sin límite.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1511988617509-a57c8a288659?q=80&w=2071&auto=format&fit=crop" } } },
      fechaFin: new Date(new Date().getTime() + 120 * 60 * 60 * 1000).toISOString(),
      tipo: "Planes",
      destacado: false,
    }
  }
];

// Filtramos destacados vs grid normal
const heroPromos = responseContentful.filter(p => p.fields.destacado);
const gridPromos = responseContentful.filter(p => !p.fields.destacado);
---

<BaseLayout
  title="Promociones Exclusivas | Línea Digital"
  description="Las mejores ofertas en telefonía e internet por tiempo limitado."
>
  
  <!-- === 1. HERO SWIPER CAROUSEL (Spotlight) === -->
  {heroPromos.length > 0 && (
    <section class="relative h-[90vh] min-h-[600px] bg-slate-50 dark:bg-slate-900 overflow-hidden">
      
      <div class="swiper hero-swiper h-full w-full">
        <div class="swiper-wrapper">
          {heroPromos.map((promo) => (
            <div class="swiper-slide relative h-full w-full">
              
              <!-- Background Image with Overlay -->
              <div class="absolute inset-0 z-0">
                <img 
                  src={promo.fields.imagen.fields.file.url} 
                  alt={promo.fields.titulo}
                  class="h-full w-full object-cover dark:opacity-70"
                  loading="eager"
                />
                <!-- Cinematic Gradient Overlay (Adaptive) -->
                <div class="absolute inset-0 bg-gradient-to-t from-white/90 via-white/40 to-transparent dark:from-slate-950 dark:via-slate-950/40"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-white/90 via-white/40 to-transparent dark:from-slate-950/90 dark:via-slate-950/50"></div>
              </div>

              <!-- Content Container -->
              <div class="container relative z-10 mx-auto px-6 h-full flex flex-col justify-center items-start">
                <div class="max-w-3xl pt-20 animate-fade-up">
                  
                  <!-- Badge -->
                  <div class="inline-flex items-center gap-2 rounded-full border border-red-500/30 bg-red-500/10 px-4 py-1.5 backdrop-blur-md mb-8 shadow-lg shadow-red-500/10">
                      <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                      </span>
                      <span class="text-xs font-bold text-red-600 dark:text-red-400 uppercase tracking-[0.2em]">{promo.fields.tipo}</span>
                  </div>

                  <!-- Title -->
                  <h1 class="text-4xl sm:text-5xl md:text-6xl font-black tracking-tighter leading-[0.95] text-slate-900 dark:text-white mb-8">
                    {promo.fields.titulo}
                  </h1>

                  <!-- Desc -->
                  <p class="text-lg md:text-xl leading-relaxed text-slate-500 dark:text-slate-400 mb-10">
                    {promo.fields.descripcion}
                  </p>

                  <!-- TIMER BLOCK (If active) -->
                  {promo.fields.fechaFin && (
                    <div class="mb-10 flex flex-wrap gap-4 items-center" data-timer-target={promo.fields.fechaFin}>
                         <span class="text-xs font-bold uppercase tracking-widest text-slate-500 dark:text-slate-400">Expira en:</span>
                         
                         <div class="flex gap-3">
                             <div class="bg-white/60 dark:bg-white/10 backdrop-blur-md border border-slate-200 dark:border-white/20 rounded-xl px-4 py-2 min-w-[70px] text-center shadow-sm">
                                 <span class="block text-2xl font-bold text-slate-900 dark:text-white timer-d">00</span>
                                 <span class="block text-2xs text-slate-500 dark:text-slate-400 uppercase tracking-wide">Días</span>
                             </div>
                             <div class="bg-white/60 dark:bg-white/10 backdrop-blur-md border border-slate-200 dark:border-white/20 rounded-xl px-4 py-2 min-w-[70px] text-center shadow-sm">
                                 <span class="block text-2xl font-bold text-slate-900 dark:text-white timer-h">00</span>
                                 <span class="block text-2xs text-slate-500 dark:text-slate-400 uppercase tracking-wide">Hrs</span>
                             </div>
                             <div class="bg-blue-50/80 dark:bg-blue-600/80 backdrop-blur-md border border-blue-200 dark:border-blue-500 rounded-xl px-4 py-2 min-w-[70px] text-center shadow-[0_0_30px_rgba(37,99,235,0.2)] dark:shadow-[0_0_30px_rgba(37,99,235,0.4)]">
                                 <span class="block text-2xl font-bold text-blue-600 dark:text-white timer-m">00</span>
                                 <span class="block text-2xs text-blue-600 dark:text-blue-200 uppercase tracking-wide">Min</span>
                             </div>
                         </div>
                    </div>
                  )}

                  <!-- CTAs -->
                  <div class="flex flex-wrap gap-4">
                     <Button 
                       href={`https://wa.me/529616189200?text=Me interesa la oferta: ${promo.fields.titulo}`}
                       target="_blank"
                       variant="primary"
                       size="lg"
                       class="group gap-3"
                     >
                        <svg class="w-5 h-5 transition-transform group-hover:-rotate-12" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.548 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                         <span>Reclamar Oferta</span>
                     </Button>
                     <button class="share-btn px-6 py-4 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100 dark:border-white/20 dark:text-white dark:hover:bg-white/10 transition-all backdrop-blur" data-title={promo.fields.titulo}>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                     </button>
                  </div>

                </div>
              </div>
            </div>
          ))}
        </div>
        
        <!-- Navigation Dots Custom -->
        <div class="swiper-pagination !bottom-10 !px-12 !text-left !w-auto"></div>
      </div>
    </section>
  )}

  <!-- === 2. BENTO GRID OFERTAS (El resto) === -->
  <section class="relative py-24 bg-gradient-to-b from-slate-50 to-transparent dark:from-slate-950 dark:to-transparent border-t border-slate-100 dark:border-white/5">
    <div class="container mx-auto px-4 md:px-8">
      
      <!-- Grid Header -->
      <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6 animate-fade-up">
         <div>
            <h2 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white mb-6">Más Oportunidades</h2>
            <p class="text-slate-500 dark:text-slate-400 text-lg md:text-xl">Ofertas vigentes que podrías haber pasado por alto.</p>
         </div>
         <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 px-4 py-2 rounded-xl shadow-sm">
             <span class="text-sm font-mono text-blue-600 dark:text-blue-400 font-bold">{gridPromos.length} ACTIVAS</span>
         </div>
      </div>

      <!-- Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {gridPromos.map((promo, index) => (
          <article class="group relative flex flex-col rounded-[2.5rem] overflow-hidden bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-lg shadow-slate-200/50 dark:shadow-black/20 transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl">
            
            <!-- Badge Float -->
            <div class="absolute top-6 left-6 z-20">
               <span class="px-3 py-1 rounded-lg bg-white/90 dark:bg-black/80 backdrop-blur text-2xs font-bold uppercase tracking-widest text-slate-900 dark:text-white shadow-sm">
                 {promo.fields.tipo}
               </span>
            </div>

            <!-- Imagen Area -->
            <div class="relative h-72 overflow-hidden">
               <!-- Overlay Gradiente -->
               <div class="absolute inset-0 bg-gradient-to-t from-slate-900/60 to-transparent z-10 transition-opacity group-hover:opacity-80"></div>
               <img 
                  src={promo.fields.imagen.fields.file.url} 
                  alt={promo.fields.titulo}
                  class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
               />
               
               {/* Mini Timer (solo si tiene fecha) */}
               {promo.fields.fechaFin && (
                  <div class="absolute bottom-4 right-4 z-20 flex items-center gap-2 px-3 py-1 rounded-full bg-red-600 text-white text-xs font-bold shadow-lg border border-red-400 animate-pulse-slow">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                      <span class="mini-countdown" data-end={promo.fields.fechaFin}>...</span>
                  </div>
               )}
            </div>

            <!-- Body -->
            <div class="flex flex-col flex-1 p-8">
               <h3 class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white mb-3">
                  {promo.fields.titulo}
               </h3>
               <p class="text-base leading-relaxed text-slate-500 dark:text-slate-400 flex-1 mb-8">
                  {promo.fields.descripcion}
               </p>
               
               <div class="flex gap-3 pt-6 border-t border-slate-100 dark:border-slate-800">
                   <a 
                     href={`https://wa.me/529616189200?text=Info promo: ${promo.fields.titulo}`}
                     target="_blank"
                     class="flex-1 flex items-center justify-center gap-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl py-3 text-xs font-bold uppercase tracking-widest transition-transform hover:scale-[1.02]"
                   >
                     Ver Detalles
                   </a>
                   <button class="share-btn-small p-3 rounded-xl border border-slate-200 text-slate-400 hover:text-blue-600 hover:border-blue-200 dark:border-slate-700 transition-all" data-title={promo.fields.titulo}>
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                   </button>
               </div>
            </div>

          </article>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<!-- SCRIPT Y ESTILOS -->
<script>
  import Swiper from 'swiper';
  import { Autoplay, Pagination, EffectFade } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/effect-fade';
  import 'swiper/css/pagination';

  // Función init que maneja todo el ciclo de vida
  const initPromos = () => {
     // 1. Init Swiper
     const swiperEl = document.querySelector('.hero-swiper') as HTMLElement;
     if (swiperEl && !(swiperEl as any).swiper) {
         new Swiper(swiperEl, {
            modules: [Autoplay, Pagination, EffectFade],
            effect: 'fade',
            fadeEffect: { crossFade: true },
            speed: 1500,
            loop: true,
            autoplay: {
                delay: 5000,
                disableOnInteraction: false,
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
                renderBullet: (index, className) => {
                   return `<span class="${className} !w-8 !h-1 !rounded-sm !bg-slate-900 dark:!bg-white !opacity-50 hover:!opacity-100 !transition-all"></span>`;
                }
            }
         });
     }

     // 2. Timer System Robust
     const updateTimes = () => {
        const now = new Date().getTime();
        
        // Hero Timers
        document.querySelectorAll('[data-timer-target]').forEach(el => {
            const target = new Date(el.getAttribute('data-timer-target') || '').getTime();
            const distance = target - now;
            
            if (distance < 0) {
                el.innerHTML = `<span class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold text-sm">¡Terminada!</span>`;
                return;
            }
            
            const d = Math.floor(distance / (1000 * 60 * 60 * 24));
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

            // Update only if content changed to prevent layout trashing
            updateText(el, '.timer-d', d.toString().padStart(2, '0'));
            updateText(el, '.timer-h', h.toString().padStart(2, '0'));
            updateText(el, '.timer-m', m.toString().padStart(2, '0'));
        });

        // Mini Timers
        document.querySelectorAll('.mini-countdown').forEach(el => {
            const target = new Date(el.getAttribute('data-end') || '').getTime();
            const distance = target - now;
            if(distance < 0) {
                el.textContent = "Terminó";
                el.parentElement?.classList.replace('bg-red-600', 'bg-gray-500');
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            el.textContent = `${days}d ${hours}h`;
        });
     }
     
     // Start Loop
     const interval = setInterval(updateTimes, 1000);
     updateTimes(); // Run immediate

     // Share Buttons
     const setupShare = (selector: string) => {
         document.querySelectorAll(selector).forEach(btn => {
             // remove old listeners clean if using navigating (optional for advanced setup)
             btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const title = btn.getAttribute('data-title') || 'Promoción';
                
                if(navigator.share) {
                    await navigator.share({ title: title, url: window.location.href });
                } else {
                    await navigator.clipboard.writeText(window.location.href);
                    alert('Enlace copiado');
                }
             });
         });
     }
     setupShare('.share-btn');
     setupShare('.share-btn-small');

     // Helper Text Update
     function updateText(parent: Element, selector: string, val: string) {
        const el = parent.querySelector(selector);
        if(el && el.textContent !== val) el.textContent = val;
     }
  }

  document.addEventListener('astro:page-load', initPromos);
  if (document.readyState === 'complete') initPromos();
  else document.addEventListener('DOMContentLoaded', initPromos);
</script>

<style>
  /* Pagination Styles Override */
  :global(.swiper-pagination-bullet-active) {
      background-color: #0f172a !important; /* slate-900 */
      opacity: 1 !important;
      width: 2rem !important; 
  }
  
  @media (prefers-color-scheme: dark) {
    :global(.swiper-pagination-bullet-active) {
        background-color: #0f172a !important;
    }
  }
  
  /* Manual Dark Mode override if using class="dark" on html */
  :global(.dark .swiper-pagination-bullet-active) {
      background-color: #fff !important;
  }
  
  @keyframes fade-up {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-up { animation: fade-up 0.8s ease-out forwards; }
</style>