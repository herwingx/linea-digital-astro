---
// src/pages/promociones.astro
import BaseLayout from "../layouts/BaseLayout.astro";

// === TYPES ===
interface PromoField {
  titulo: string;
  descripcion: string;
  imagen: { fields: { file: { url: string } } };
  fechaFin: string | null;
  tipo: string;
  destacado: boolean;
}

interface ContentfulItem {
  sys: { id: string };
  fields: PromoField;
}

// === DATA MOCK (Optimizada para Marketing) ===
const responseContentful: ContentfulItem[] = [
  // HERO ITEMS (Flagships que venden solos)
  {
    sys: { id: "hero-1" },
    fields: {
      titulo: "iPhone 15 Pro Max",
      descripcion: "Titanio aeroespacial. Chip A17 Pro. Llévatelo hoy con 0% de interés y doble de gigas por 12 meses.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1695048133142-1a20484d2569?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: new Date(Date.now() + 48 * 3600 * 1000).toISOString(),
      tipo: "Oferta Flash",
      destacado: true,
    },
  },
  {
    sys: { id: "hero-2" },
    fields: {
      titulo: "PlayStation 5 Slim",
      descripcion: "El regalo perfecto existe. Incluye FC 24 + 2 Controles. Pocas unidades disponibles.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1606144042614-b2417e99c4e3?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: new Date(Date.now() + 72 * 3600 * 1000).toISOString(),
      tipo: "Bundle Exclusivo",
      destacado: true,
    },
  },
  // GRID ITEMS (Productos Gancho)
  {
    sys: { id: "grid-1" },
    fields: {
      titulo: "Internet Simétrico 1GB",
      descripcion: "La fibra óptica más rápida de la región. Instalación express en 24 horas.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop" } } },
      fechaFin: new Date(Date.now() + 120 * 3600 * 1000).toISOString(),
      tipo: "Servicios",
      destacado: false, 
    },
  },
  {
    sys: { id: "grid-2" },
    fields: {
      titulo: "Galaxy S24 Ultra",
      descripcion: "Traduce llamadas en tiempo real con Galaxy AI. Preventa exclusiva.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1610945265078-d86f3d297dfb?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: null,
      tipo: "Preventa",
      destacado: false,
    },
  },
  {
    sys: { id: "grid-3" },
    fields: {
      titulo: "Apple Watch Ultra 2",
      descripcion: "El reloj definitivo para deportistas extremos.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1695646199432-8df7d9d8c67c?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: null,
      tipo: "Wearable",
      destacado: false,
    },
  },
  {
    sys: { id: "grid-4" },
    fields: {
      titulo: "Sony WH-1000XM5",
      descripcion: "Cancelación de ruido líder en la industria. Envío gratis.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1618366712010-f4ae9c647dcb?q=80&w=1888&auto=format&fit=crop" } } },
      fechaFin: new Date(Date.now() + 10 * 3600 * 1000).toISOString(),
      tipo: "Audio",
      destacado: false,
    },
  }
];

const heroPromos = responseContentful.filter((p) => p.fields.destacado);
const gridPromos = responseContentful.filter((p) => !p.fields.destacado);

const WA_NUMBER = "529614603593";
---

<BaseLayout
  title="Ofertas Exclusivas | Línea Digital"
  description="Tecnología de punta y planes exclusivos disponibles por tiempo limitado. Aprovecha nuestras promociones hoy."
>
  
  <!-- === HERO SECTION === -->
  {heroPromos.length > 0 && (
    <section class="relative w-full h-[85vh] min-h-[640px] bg-[#020617] overflow-hidden group">
        
      <!-- Background Glow Spot -->
      <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[60vw] h-[60vw] bg-blue-500/10 blur-[120px] rounded-full mix-blend-screen pointer-events-none z-0"></div>

      <!-- SWIPER CONTAINER -->
      <div class="swiper hero-swiper w-full h-full relative z-10">
        <div class="swiper-wrapper">
          {heroPromos.map((promo, index) => (
            <div class="swiper-slide relative w-full h-full overflow-hidden">
                
                <!-- 1. Imagen (Zoom suave via CSS) -->
                <div class="absolute inset-0 w-full h-full">
                     <img
                        src={promo.fields.imagen.fields.file.url}
                        alt={promo.fields.titulo}
                        class="h-full w-full object-cover transition-transform duration-[20s] ease-linear scale-100 group-hover:scale-110" 
                        loading={index === 0 ? "eager" : "lazy"}
                    />
                    <!-- Overlay Gradiente Profesional para legibilidad -->
                    <div class="absolute inset-0 bg-gradient-to-t from-[#020617] via-[#020617]/50 to-transparent opacity-90" />
                    <div class="absolute inset-0 bg-gradient-to-r from-[#020617]/80 via-transparent to-transparent opacity-80" />
                </div>

                <!-- 2. Contenido Flotante -->
                <div class="relative z-10 container mx-auto px-6 h-full flex flex-col justify-end pb-32 md:justify-center md:pb-0">
                    <div class="max-w-4xl space-y-6 md:space-y-8 pl-0 md:pl-8 border-l-0 md:border-l-4 border-blue-500/0 md:border-blue-500/50 md:backdrop-blur-sm md:bg-white/0 transition-all duration-700">
                        
                        <!-- Etiqueta Glass -->
                        <div class="opacity-0 translate-y-8 slide-content-entry inline-flex">
                             <div class="relative inline-flex items-center justify-center rounded-full bg-blue-600/20 backdrop-blur-md px-4 py-1.5 border border-blue-400/30 shadow-[0_0_15px_rgba(59,130,246,0.5)]">
                                <span class="relative flex h-2 w-2 mr-2">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                                </span>
                                <span class="text-xs font-bold uppercase tracking-[0.2em] text-blue-100">{promo.fields.tipo}</span>
                             </div>
                        </div>

                        <!-- Título -->
                        <h1 class="text-5xl md:text-7xl lg:text-8xl font-black text-white tracking-tighter leading-[0.9] drop-shadow-2xl opacity-0 translate-y-8 transition-all duration-700 delay-100 slide-content-entry">
                            {promo.fields.titulo}
                        </h1>
                        
                        <!-- Descripción -->
                        <p class="text-lg md:text-2xl text-slate-300 font-medium leading-relaxed max-w-2xl opacity-0 translate-y-8 transition-all duration-700 delay-200 slide-content-entry">
                            {promo.fields.descripcion}
                        </p>

                        <!-- Actions -->
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-6 pt-4 opacity-0 translate-y-8 transition-all duration-700 delay-300 slide-content-entry">
                            <a
                                href={`https://wa.me/${WA_NUMBER}?text=Hola, me interesa la promoción de: ${promo.fields.titulo}`}
                                target="_blank"
                                class="group/btn relative inline-flex items-center gap-3 overflow-hidden rounded-full bg-white px-8 py-4 font-bold uppercase tracking-widest text-slate-900 transition-all hover:scale-105 active:scale-95 shadow-[0_0_30px_rgba(255,255,255,0.3)]"
                            >
                                <span class="relative z-10">Cotizar Ahora</span>
                                <svg class="relative z-10 w-4 h-4 transition-transform group-hover/btn:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                                <div class="absolute inset-0 -translate-x-full group-hover/btn:animate-[shine_1.5s_infinite] bg-gradient-to-r from-transparent via-slate-200/50 to-transparent z-0"></div>
                            </a>

                            {promo.fields.fechaFin && (
                                <div class="flex items-center gap-3 px-4 py-2 rounded-xl bg-black/40 backdrop-blur-md border border-white/10" data-timer-target={promo.fields.fechaFin}>
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Expira en:</span>
                                    <div class="font-mono text-lg font-bold flex gap-1 tabular-nums tracking-wider text-red-400">
                                        <span class="timer-d">00</span>d :
                                        <span class="timer-h">00</span>h :
                                        <span class="timer-m">00</span>m
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
          ))}
        </div>

        <!-- Pagination (Capsule Style) -->
        <div class="absolute bottom-10 right-0 left-0 flex justify-center md:justify-end md:right-12 z-30">
             <div class="swiper-pagination-custom-container bg-black/40 backdrop-blur-md border border-white/10 px-4 py-2 rounded-full flex items-center gap-3">
                <!-- Bullets injected via JS -->
             </div>
        </div>
      </div>
    </section>
  )}

  <!-- === GRID SECTION === -->
  <section class="py-24 bg-[#F8FAFC] dark:bg-[#020617] relative transition-colors duration-500">
    <!-- Grid Light/Dark Divider Gradient -->
    <div class="absolute top-0 inset-x-0 h-32 bg-gradient-to-b from-[#020617] to-transparent pointer-events-none opacity-100 z-10"></div>

    <!-- Header -->
    <div class="container mx-auto px-6 mb-16 relative z-10 flex flex-col md:flex-row md:items-end justify-between gap-6">
        <div class="max-w-3xl">
            <span class="text-blue-600 dark:text-blue-400 font-bold uppercase tracking-widest text-xs mb-2 block">Oportunidades</span>
            <h2 class="text-4xl md:text-5xl font-black text-slate-900 dark:text-white tracking-tighter mb-4">
                Catálogo <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500">Destacado</span>.
            </h2>
            <p class="text-slate-500 dark:text-slate-400 text-lg leading-relaxed">
                Selección de equipos con alta demanda y disponibilidad inmediata.
            </p>
        </div>
    </div>

    <!-- BENTO GRID -->
    <div class="container mx-auto px-6 pb-20 relative z-10">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-[450px]">
        {gridPromos.map((promo, index) => {
            // Diseño asimétrico: el primer elemento de cada fila de 3 ocupa 2 columnas en MD
            const isWide = index % 3 === 0;
            return (
                <article 
                    class={`
                        group relative rounded-[2.5rem] overflow-hidden 
                        bg-white dark:bg-[#0f172a] 
                        border border-slate-200 dark:border-white/5
                        shadow-lg shadow-slate-200/50 dark:shadow-none
                        hover:shadow-2xl hover:shadow-blue-500/10 hover:-translate-y-2
                        transition-all duration-500 ease-out
                        ${isWide ? "md:col-span-2" : "md:col-span-1"}
                    `}
                >
                  <!-- Full Card Link (Clickable area) -->
                  <a 
                    href={`https://wa.me/${WA_NUMBER}?text=Me interesa: ${promo.fields.titulo}`}
                    target="_blank" 
                    class="absolute inset-0 z-40 cursor-pointer"
                    aria-label={`Ver oferta de ${promo.fields.titulo}`}
                  ></a>

                  <!-- Image Container -->
                  <div class="absolute inset-0 z-0 h-full w-full bg-slate-900">
                    <img
                      src={promo.fields.imagen.fields.file.url}
                      alt=""
                      class="h-full w-full object-cover transition-transform duration-1000 ease-out group-hover:scale-110 opacity-80 group-hover:opacity-60"
                      loading="lazy"
                    />
                    <!-- Gradients para legibilidad -->
                    <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-transparent opacity-90 transition-opacity" />
                  </div>

                  <!-- Text Content -->
                  <div class="relative z-20 h-full flex flex-col justify-between p-8 md:p-10 select-none pointer-events-none">
                    
                    <!-- Tag Badge -->
                    <div class="flex justify-start">
                        <span class="inline-flex items-center rounded-lg bg-white/10 backdrop-blur-md border border-white/10 px-3 py-1 text-[10px] font-bold uppercase tracking-widest text-white shadow-sm">
                            {promo.fields.tipo}
                        </span>
                    </div>

                    <!-- Bottom Info -->
                    <div class="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-500 ease-out">
                        <h3 class={`text-white font-black leading-tight mb-2 drop-shadow-lg ${isWide ? 'text-4xl md:text-5xl' : 'text-3xl'}`}>
                            {promo.fields.titulo}
                        </h3>
                        
                        <div class="h-0 group-hover:h-auto overflow-hidden transition-all duration-500">
                             <p class="text-slate-300 text-sm font-medium leading-relaxed max-w-md opacity-0 group-hover:opacity-100 transition-opacity duration-500 delay-100 mb-6 border-l-2 border-blue-500 pl-3">
                                {promo.fields.descripcion}
                             </p>
                        </div>
                        
                        <!-- Botón Simulado (Visual only, el link es la card entera) -->
                        <div class="flex items-center gap-2 text-blue-300 text-xs font-bold uppercase tracking-widest opacity-80 group-hover:opacity-100 group-hover:text-white transition-colors">
                             <span>Consultar Precio</span>
                             <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
                        </div>
                    </div>
                  </div>
                </article>
            );
        })}
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  import Swiper from "swiper";
  import { Autoplay, EffectCreative, Pagination } from "swiper/modules";
  import "swiper/css";
  
  // Script Optimizado
  const init = () => {
    // 1. Swiper
    const swiperEl = document.querySelector(".hero-swiper") as HTMLElement & { swiper?: any };
    
    if (swiperEl && !swiperEl.swiper) {
      new Swiper(swiperEl, {
        modules: [Autoplay, EffectCreative, Pagination],
        effect: "creative",
        creativeEffect: {
          prev: { shadow: true, translate: ["-20%", 0, -1], opacity: 0 },
          next: { translate: ["100%", 0, 0] },
        },
        speed: 1000,
        loop: true,
        autoplay: { delay: 5000, disableOnInteraction: false },
        pagination: { 
            el: ".swiper-pagination-custom-container", 
            clickable: true,
            renderBullet: (_index, className) => {
                return `<button class="${className} w-2 h-2 rounded-full bg-white/50 hover:bg-white transition-all duration-300 mx-1" aria-label="Go to slide"></button>`;
            }
        },
      });
    }

    // 2. Countdown Timer
    const updateTimers = () => {
      const now = Date.now();
      document.querySelectorAll("[data-timer-target]").forEach((el) => {
        const targetStr = el.getAttribute("data-timer-target");
        if(!targetStr) return;
        const end = new Date(targetStr).getTime();
        const diff = end - now;

        if (diff <= 0) return; // Expired

        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        const setVal = (sel: string, v: number) => {
             const node = el.querySelector(sel);
             if(node) node.textContent = v.toString().padStart(2, '0');
        };
        setVal('.timer-d', d); setVal('.timer-h', h); setVal('.timer-m', m);
      });
    };
    
    updateTimers(); 
    const interval = setInterval(updateTimers, 60000); // Actualizar cada minuto es suficiente para D/H/M
    
    // Clean interval on navigation
    document.addEventListener("astro:before-swap", () => clearInterval(interval), { once: true });
  };

  document.addEventListener("astro:page-load", init);
  document.addEventListener("DOMContentLoaded", init);
</script>

<style is:global>
  /* --- CUSTOM SWIPER PAGINATION --- */
  .swiper-pagination-bullet {
    width: 6px !important;
    height: 6px !important;
    margin: 0 4px !important;
    background: rgba(255, 255, 255, 0.4) !important;
    opacity: 1 !important;
    transition: all 0.3s ease;
  }

  .swiper-pagination-bullet-active {
    background: #fff !important;
    transform: scale(1.5);
    box-shadow: 0 0 10px rgba(255,255,255,0.8);
  }

  /* --- TEXT ANIMATIONS --- */
  .swiper-slide-active .slide-content-entry {
    opacity: 1 !important;
    transform: translateY(0) !important;
  }

  .slide-content-entry {
    transition-timing-function: cubic-bezier(0.16, 1, 0.3, 1); /* Ease Out Expo */
  }
  
  @keyframes shine {
      100% { left: 125%; }
  }
</style>