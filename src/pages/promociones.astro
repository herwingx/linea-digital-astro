---
import BaseLayout from "../layouts/BaseLayout.astro";

// --- MOCK DATA ROBUSTO ---
const responseContentful = [
  {
    sys: { id: "1" },
    fields: {
      titulo: "iPhone 15 Pro - Titanium",
      descripcion: "La potencia definitiva en tus manos. Contrátalo en Plan Telcel Plus 5 con doble de gigas x12 meses.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1696446701796-da61225697cc?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: new Date(new Date().getTime() + 48 * 60 * 60 * 1000).toISOString(),
      tipo: "Equipos Premium",
      destacado: true,
    }
  },
  {
    sys: { id: "2" },
    fields: {
      titulo: "Internet Casa 50 Megas",
      descripcion: "Olvídate de los cables. Conéctate al instante y recibe 1 mes de Prime Video de regalo.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1544197150-b99a580bb7a8?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: new Date(new Date().getTime() + 5 * 24 * 60 * 60 * 1000).toISOString(),
      tipo: "Hogar",
      destacado: false,
    }
  },
  {
    sys: { id: "3" },
    fields: {
      titulo: "Renueva tu Samsung",
      descripcion: "Bono de $2,000 en la Serie S24 al renovar tu plan actual antes de fin de mes.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1610945265078-38584e106955?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: null,
      tipo: "Renovación",
      destacado: false,
    }
  }
];

const heroPromo = responseContentful.find(p => p.fields.destacado);
const gridPromos = responseContentful.filter(p => !p.fields.destacado);

// Helper para formateo de fechas en tarjetas normales
const formatDate = (iso: string) => new Date(iso).toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
---

<BaseLayout
  title="Promociones | Línea Digital"
  description="Ofertas flash en telefonía móvil e internet. Tiempo limitado."
>
  
  <!-- === 1. HERO SECTION "LIMITED DROP" === -->
  {heroPromo && (
    <section class="relative min-h-[85vh] flex items-center justify-center overflow-hidden bg-slate-950">
      
      <!-- Fondo Cinemático -->
      <div class="absolute inset-0 pointer-events-none">
        <!-- Imagen con Máscara -->
        <div class="absolute inset-0 opacity-60">
            <img 
                src={heroPromo.fields.imagen.fields.file.url} 
                alt={heroPromo.fields.titulo}
                class="w-full h-full object-cover"
            />
            <!-- Gradiente Radial para foco -->
            <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/50 to-transparent"></div>
            <div class="absolute inset-0 bg-gradient-to-r from-slate-950 via-slate-950/60 to-transparent"></div>
        </div>
      </div>

      <!-- Contenido Flotante -->
      <div class="container relative z-10 px-6 md:px-8 pt-20">
        <div class="max-w-3xl animate-fade-up">
          
          <!-- Etiqueta Exclusiva -->
          <div class="inline-flex items-center gap-2 rounded-full border border-red-500/30 bg-red-500/10 px-4 py-1.5 backdrop-blur-md mb-8 shadow-[0_0_20px_rgba(239,68,68,0.4)]">
             <span class="relative flex h-2 w-2">
               <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
               <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
             </span>
             <span class="text-xs font-bold text-red-400 uppercase tracking-[0.2em]">Oferta Relámpago</span>
          </div>

          <h1 class="text-5xl md:text-8xl font-bold text-white tracking-tighter mb-6 leading-[0.9]">
             {heroPromo.fields.titulo}
          </h1>
          
          <p class="text-xl text-slate-300 leading-relaxed mb-10 font-light border-l-4 border-blue-500 pl-6">
             {heroPromo.fields.descripcion}
          </p>

          <!-- TIMER CARDS (Modern Blocks) -->
          {heroPromo.fields.fechaFin && (
            <div class="mb-12" data-timer-target={heroPromo.fields.fechaFin}>
                <p class="text-xs text-slate-400 uppercase tracking-widest mb-4 font-bold">La oferta termina en:</p>
                <div class="flex flex-wrap gap-4">
                    <div class="flex flex-col items-center justify-center w-20 h-24 md:w-24 md:h-32 bg-slate-800/50 backdrop-blur-md border border-white/10 rounded-2xl">
                        <span class="text-3xl md:text-5xl font-bold text-white timer-days">00</span>
                        <span class="text-[10px] uppercase text-slate-500 font-bold tracking-widest mt-1">Días</span>
                    </div>
                    <div class="flex flex-col items-center justify-center w-20 h-24 md:w-24 md:h-32 bg-slate-800/50 backdrop-blur-md border border-white/10 rounded-2xl">
                        <span class="text-3xl md:text-5xl font-bold text-white timer-hours">00</span>
                        <span class="text-[10px] uppercase text-slate-500 font-bold tracking-widest mt-1">Horas</span>
                    </div>
                    <div class="flex flex-col items-center justify-center w-20 h-24 md:w-24 md:h-32 bg-slate-800/50 backdrop-blur-md border border-white/10 rounded-2xl shadow-[0_0_30px_rgba(59,130,246,0.15)]">
                        <span class="text-3xl md:text-5xl font-bold text-blue-400 timer-minutes">00</span>
                        <span class="text-[10px] uppercase text-blue-500/70 font-bold tracking-widest mt-1">Minutos</span>
                    </div>
                </div>
            </div>
          )}

          <div class="flex flex-wrap gap-4">
             <a 
               href={`https://wa.me/529616189200?text=Quiero la promo: ${heroPromo.fields.titulo}`}
               class="group relative px-8 py-4 bg-white text-slate-900 text-sm font-bold uppercase tracking-widest rounded-full hover:bg-blue-50 transition-all hover:scale-105 overflow-hidden flex items-center gap-2"
             >
               <span class="relative z-10">Reclamar Oferta</span>
               <svg class="w-4 h-4 relative z-10 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
             </a>
             
             <button 
                data-share-btn 
                data-title={heroPromo.fields.titulo} 
                data-desc={heroPromo.fields.descripcion}
                class="px-6 py-4 bg-slate-800/50 text-white border border-white/10 rounded-full hover:bg-slate-800 hover:border-white/30 transition-all"
             >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
             </button>
          </div>

        </div>
      </div>
    </section>
  )}

  <!-- === 2. CATALOGO DE PROMOCIONES (Bento Grid) === -->
  <section class="relative py-24 bg-slate-50 dark:bg-slate-900">
      <div class="container mx-auto px-6 md:px-8">
          
          <div class="flex flex-wrap items-end justify-between mb-12 gap-6">
              <div>
                  <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Otras Oportunidades</h2>
                  <p class="text-slate-500">No las dejes pasar, algunas expiran pronto.</p>
              </div>
              <div class="px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-white/5 shadow-sm text-xs font-mono text-slate-500">
                  {gridPromos.length} Activas
              </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              {gridPromos.map(promo => (
                  <div class="group relative flex flex-col overflow-hidden rounded-[2.5rem] bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 transition-all duration-500 hover:shadow-2xl hover:-translate-y-2">
                      
                      <!-- Badge Tipo -->
                      <div class="absolute top-6 left-6 z-20">
                          <span class="px-3 py-1.5 rounded-lg bg-white/90 dark:bg-black/60 backdrop-blur text-[10px] font-bold uppercase tracking-wider shadow-sm border border-slate-200/50 dark:border-white/10">
                              {promo.fields.tipo}
                          </span>
                      </div>

                      <!-- Imagen Scale Effect -->
                      <div class="relative h-72 w-full overflow-hidden">
                          <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 to-transparent z-10"></div>
                          <img 
                             src={promo.fields.imagen.fields.file.url} 
                             alt={promo.fields.titulo}
                             class="h-full w-full object-cover transition-transform duration-700 group-hover:scale-110"
                             loading="lazy"
                          />
                          
                          <!-- Timer Flotante (Mini) -->
                          {promo.fields.fechaFin && (
                             <div class="absolute bottom-4 right-4 z-20 flex items-center gap-2 text-xs font-bold text-red-400 bg-slate-900/80 backdrop-blur px-3 py-1.5 rounded-full border border-red-500/30">
                                 <span class="relative flex h-1.5 w-1.5">
                                   <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                   <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-red-500"></span>
                                 </span>
                                 <span data-mini-timer={promo.fields.fechaFin}>Calculando...</span>
                             </div>
                          )}
                      </div>

                      <!-- Info -->
                      <div class="flex flex-col flex-1 p-8">
                          <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-3 leading-tight group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                              {promo.fields.titulo}
                          </h3>
                          <p class="text-slate-500 dark:text-slate-400 text-sm leading-relaxed mb-8 line-clamp-3 flex-1">
                              {promo.fields.descripcion}
                          </p>

                          <div class="flex items-center gap-3 pt-6 border-t border-slate-100 dark:border-slate-800">
                              <a href={`https://wa.me/529616189200?text=Info promo: ${promo.fields.titulo}`} class="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl bg-slate-900 text-white text-xs font-bold uppercase tracking-widest hover:bg-blue-600 transition-colors dark:bg-white dark:text-slate-900">
                                  Ver detalles
                              </a>
                              <button data-share-btn data-title={promo.fields.titulo} class="p-3 rounded-xl border border-slate-200 text-slate-400 hover:border-blue-300 hover:text-blue-500 transition-colors dark:border-slate-700">
                                 <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                              </button>
                          </div>
                      </div>
                  </div>
              ))}
          </div>
      </div>
  </section>
  
</BaseLayout>

<script>
  // --- LOGICA CLIENTE: TIMERS & SHARE ---
  document.addEventListener('DOMContentLoaded', () => {
      
      // 1. Countdown Manager (High Performance)
      const bigTimer = document.querySelector('[data-timer-target]');
      const miniTimers = document.querySelectorAll('[data-mini-timer]');

      function updateClock() {
          const now = new Date().getTime();
          
          // Hero Timer Update
          if(bigTimer) {
             const end = new Date(bigTimer.getAttribute('data-timer-target') || '').getTime();
             const dist = end - now;

             if(dist > 0) {
                 const days = Math.floor(dist / (1000 * 60 * 60 * 24));
                 const hours = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                 const minutes = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
                 
                 updateText('.timer-days', days.toString().padStart(2, '0'), bigTimer);
                 updateText('.timer-hours', hours.toString().padStart(2, '0'), bigTimer);
                 updateText('.timer-minutes', minutes.toString().padStart(2, '0'), bigTimer);
             } else {
                 bigTimer.innerHTML = '<span class="text-red-500 font-bold text-2xl">¡Oferta Expirada!</span>';
             }
          }

          // Mini Timers
          miniTimers.forEach(el => {
              const end = new Date(el.getAttribute('data-mini-timer') || '').getTime();
              const dist = end - now;
              if(dist > 0) {
                  const days = Math.floor(dist / (1000 * 60 * 60 * 24));
                  const hours = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                  el.textContent = `Termina en: ${days}d ${hours}h`;
              } else {
                  el.textContent = 'Finalizada';
                  el.parentElement?.classList.add('grayscale');
              }
          });
      }
      
      function updateText(selector, text, parent) {
         const el = parent.querySelector(selector);
         if(el && el.innerText !== text) el.innerText = text;
      }

      setInterval(updateClock, 1000);
      updateClock();

      // 2. Share Button Logic
      const shareBtns = document.querySelectorAll('[data-share-btn]');
      shareBtns.forEach(btn => {
          btn.addEventListener('click', async (e) => {
             e.preventDefault();
             const data = {
                 title: btn.getAttribute('data-title') || 'Promoción Línea Digital',
                 text: btn.getAttribute('data-desc') || 'Mira esta oferta increíble.',
                 url: window.location.href
             };

             if(navigator.share) {
                 try { await navigator.share(data); } catch(err) {}
             } else {
                 navigator.clipboard.writeText(window.location.href);
                 const original = btn.innerHTML;
                 btn.innerHTML = `<svg class="w-4 h-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
                 setTimeout(() => btn.innerHTML = original, 2000);
             }
          });
      });
  });
</script>