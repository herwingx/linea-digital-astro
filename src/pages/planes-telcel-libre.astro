---
// src/pages/planes-telcel-libre.astro
import BaseLayout from "../layouts/BaseLayout.astro";
import PlanCard from "../components/PlanTelcelLibreCard.astro";
import { getPlans } from "../services/contentful";

interface PlanFields {
  titulo: string;
  datosIncluidos: string;
  precio: number;
  recomendado?: boolean;
  enlace: string;
  redesSociales: string[];
  minutosYSmsIncluidos: string;
  cashbackTelcel: string;
}

const planes = await getPlans();

// Lógica: Ordenar precios ascendente + Identificar inicial
const planesOrdenados = planes.sort((a: any, b: any) => a.fields.precio - b.fields.precio);
const initialSlideIndex = planesOrdenados.findIndex((plan: any) => plan.fields?.recomendado === true);
const startSlide = initialSlideIndex !== -1 ? initialSlideIndex : 0;
---

<BaseLayout
  title="Planes Telcel Libre | Grupo Linea Digital"
  description="Contrata los mejores planes Telcel Libre con GB incluidos y redes sociales."
>
  
  <!-- Wrapper: Bg Slate 50 clean + efectos de luz -->
  <section class="relative min-h-screen flex flex-col justify-center overflow-hidden bg-slate-50 py-20 dark:bg-slate-950 transition-colors duration-500">
    
    <!-- Background Glow Effects -->
    <div class="pointer-events-none absolute top-[-10%] left-1/2 w-[1000px] h-[800px] -translate-x-1/2 bg-blue-400/10 blur-[100px] rounded-full opacity-80 mix-blend-multiply dark:bg-blue-900/20 dark:mix-blend-screen"></div>

    <div class="container relative z-10 mx-auto px-4">
      
      <!-- Minimalist Header -->
      <div class="mx-auto mb-12 max-w-3xl text-center space-y-6">
         <div class="animate-fade-up flex justify-center">
             <span class="rounded-full border border-blue-100 bg-white/50 px-4 py-1.5 text-xs font-bold uppercase tracking-widest text-blue-600 backdrop-blur-md shadow-sm dark:border-blue-900/30 dark:bg-blue-900/20 dark:text-blue-400">
                 Sin Plazos Forzosos
             </span>
         </div>
         
         <h1 class="animate-fade-up text-5xl font-bold tracking-tighter text-slate-900 dark:text-white sm:text-7xl leading-[0.9]">
           Elige tu <span class="text-blue-600">Libertad</span>
         </h1>
         
         <p class="animate-fade-up mx-auto max-w-lg text-lg text-slate-500 dark:text-slate-400 font-light leading-relaxed">
            Conecta tu vida con la red 5G de mayor cobertura. Planes diseñados para adaptarse a ti, no al revés.
         </p>
      </div>

      <!-- SLIDER CONTAINER -->
      <div class="relative mx-auto max-w-[1400px] pt-10 pb-12 swiper-container-plans">
         
         <!-- CUSTOM NAVIGATION BUTTONS (Minimalist Circles) -->
         <!-- Positioned absolute centered vertically -->
         <button class="plans-prev absolute left-2 top-1/2 z-30 -translate-y-1/2 hidden md:flex h-14 w-14 items-center justify-center rounded-full border border-slate-200 bg-white/90 text-slate-600 shadow-lg backdrop-blur transition-all hover:scale-110 hover:border-blue-300 hover:text-blue-600 focus:outline-none dark:border-slate-700 dark:bg-slate-900/80 dark:text-white dark:hover:border-blue-500">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
         </button>

         <button class="plans-next absolute right-2 top-1/2 z-30 -translate-y-1/2 hidden md:flex h-14 w-14 items-center justify-center rounded-full border border-slate-200 bg-white/90 text-slate-600 shadow-lg backdrop-blur transition-all hover:scale-110 hover:border-blue-300 hover:text-blue-600 focus:outline-none dark:border-slate-700 dark:bg-slate-900/80 dark:text-white dark:hover:border-blue-500">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
         </button>

         <!-- SWIPER WRAPPER -->
         <!-- Important: overflow-visible para que las sombras de las tarjetas no se corten -->
         <div class="swiper plans-swiper !overflow-visible px-4" data-initial-slide={startSlide}>
           <div class="swiper-wrapper items-center">
             {planesOrdenados.map((plan: any) => {
               const p = plan.fields as PlanFields;
               return (
                 <div class="swiper-slide transition-all duration-500 h-auto">
                   <PlanCard
                     titulo={p.titulo}
                     datosIncluidos={p.datosIncluidos}
                     precio={p.precio}
                     recommended={p.recomendado || false}
                     enlace={p.enlace}
                     redesSociales={p.redesSociales}
                     minutosYSms={p.minutosYSmsIncluidos}
                     cashbackTelcel={p.cashbackTelcel}
                   />
                 </div>
               );
             })}
           </div>
           
           <div class="swiper-pagination !bottom-0"></div>
         </div>

      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // Importación directa (asegúrate de tener swiper instalado: npm install swiper)
  import Swiper from 'swiper';
  import { Navigation, Pagination, EffectCreative } from 'swiper/modules';
  
  import 'swiper/css';
  import 'swiper/css/navigation';
  import 'swiper/css/pagination';

  function initSwiper() {
    const el = document.querySelector('.plans-swiper') as HTMLElement;
    if(!el) return;

    const initialSlide = parseInt(el.dataset.initialSlide || '0');

    new Swiper(el, {
       modules: [Navigation, Pagination],
       initialSlide: initialSlide,
       
       // Configuración para Mobile First
       slidesPerView: 1.15, // Mostrar un poco del siguiente
       spaceBetween: 20,
       centeredSlides: true, // Centrado siempre para buen UX móvil
       
       breakpoints: {
         640: { slidesPerView: 1.5, spaceBetween: 30 },
         1024: { slidesPerView: 2.5, spaceBetween: 40, centeredSlides: true },
         1280: { slidesPerView: 3, spaceBetween: 50, centeredSlides: true }
       },
       
       navigation: {
         nextEl: '.plans-next',
         prevEl: '.plans-prev',
       },
       
       pagination: {
         el: '.swiper-pagination',
         clickable: true,
         dynamicBullets: true
       },
       
       grabCursor: true,
       watchSlidesProgress: true, // Importante para los efectos visuales CSS
    });
  }

  document.addEventListener('astro:page-load', initSwiper);
  if(document.readyState === 'complete') initSwiper();
  else document.addEventListener('DOMContentLoaded', initSwiper);

</script>

<style>
  /* Pagination Dots Customization */
  :global(.swiper-pagination-bullet) {
    background-color: #cbd5e1;
    opacity: 1;
    transition: all 0.3s ease;
    width: 8px;
    height: 8px;
  }
  :global(.swiper-pagination-bullet-active) {
    background-color: #2563eb;
    width: 24px;
    border-radius: 4px;
  }

  /* --- EFECTO FOCUS (Simulando Coverflow moderno sin usar 3D) --- */
  
  /* Por defecto (inactivos) más pequeños y transparentes en Desktop */
  @media (min-width: 1024px) {
      .swiper-slide {
        transform: scale(0.92);
        opacity: 0.6;
        filter: blur(1px);
        z-index: 1;
      }
      
      /* La clase interna de swiper para la slide activa */
      .swiper-slide-active {
        transform: scale(1);
        opacity: 1;
        filter: blur(0);
        z-index: 10;
      }
  }
  
  /* En móvil quitamos ese efecto agresivo porque ocupa todo el ancho */
  @media (max-width: 1023px) {
      .swiper-slide {
          transform: scale(0.98);
      }
      .swiper-slide-active {
          transform: scale(1);
      }
  }
</style>