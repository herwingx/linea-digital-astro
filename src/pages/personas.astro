---
// src/pages/personas.astro
import BaseLayout from "../layouts/BaseLayout.astro";
import PlansOrchestrator from "../components/PlansOrchestrator.astro";
import {
  getPlansLibre,
  getPlansUltra,
  getPlansInternet,
  getInternetEnTuCasaLibre,
} from "../services/contentful";

// --- Helper para mapear datos seguros ---
const safeMap = (plans: any[], category: "movil" | "casa") => {
  if (!Array.isArray(plans)) return [];
  return plans
    .map((p) => {
      const f = p.fields || {};
      return {
        titulo: (f.titulo as string) || "Plan",
        datosIncluidos: (f.datosIncluidos as string) || "Datos",
        precio: Number(f.precio) || 0,
        recomendado: (f.recomendado as boolean) || false,
        enlace: (f.enlace as string) || "#",
        // Campos específicos mapeados a props universales
        redesSociales: (f.redesSociales as string[]) || [],
        minutosYSms: f.minutosYSmsIncluidos as string, // Unificar nombre prop
        cashbackTelcel: f.cashbackTelcel as string,
        velocidadDeNavegacion: f.velocidadDeNavegacion as string,
        politicasDeUso: f.politicasDeUso as string,
      };
    })
    .filter((p) => p.precio > 0)
    .sort((a, b) => a.precio - b.precio);
};

// Fetch Paralelo para velocidad
const [rawLibre, rawUltra, rawMovilInt, rawCasaInt] = await Promise.all([
  getPlansLibre().catch(() => []),
  getPlansUltra().catch(() => []),
  getPlansInternet().catch(() => []),
  getInternetEnTuCasaLibre().catch(() => []),
]);

const librePlans = safeMap(rawLibre, "movil");
const ultraPlans = safeMap(rawUltra, "movil");
const movilInternetPlans = safeMap(rawMovilInt, "movil");
// Fallback Manual por si API vacía (Demo)
const homePlans =
  rawCasaInt.length > 0
    ? safeMap(rawCasaInt, "casa")
    : [
        {
          titulo: "Básico",
          velocidadDeNavegacion: "20 Mbps",
          precio: 399,
          datosIncluidos: "Uso doméstico",
          recomendado: false,
        },
        {
          titulo: "Familiar",
          velocidadDeNavegacion: "50 Mbps",
          precio: 549,
          datosIncluidos: "HD Streaming",
          recomendado: true,
        },
      ];
---

<BaseLayout
  title="Planes Personales | Grupo Linea Digital"
  description="Conectividad móvil y para el hogar con la mejor red de México."
>
  <!-- HERO -->
  <section class="relative pt-8 pb-8 md:pt-16 px-4 text-center overflow-hidden">
    <!-- Glow BG -->
    <!--   <div
      class="absolute top-0 left-1/2 -translate-x-1/2 w-[100vh] h-[50vh] bg-blue-500/10 rounded-full blur-3xl -z-10"
    >
    </div> -->

    <span
      class="inline-block mb-4 px-4 py-1 rounded-full bg-blue-100/50 text-blue-600 font-bold text-[10px] tracking-[0.2em] uppercase border border-blue-200 dark:bg-blue-900/20 dark:text-blue-400 dark:border-blue-800 animate-fade-up"
    >
      Para Personas
    </span>
    <h1
      class="text-5xl md:text-7xl font-bold tracking-tighter text-slate-900 dark:text-white mb-6 animate-fade-up"
      style="animation-delay: 100ms"
    >
      Conecta tu <span class="text-blue-600">Mundo</span>
    </h1>
    <p
      class="text-xl text-slate-500 dark:text-slate-400 max-w-2xl mx-auto animate-fade-up"
      style="animation-delay: 200ms"
    >
      Soluciones flexibles para tu smartphone y tu hogar. Sin letras chiquitas.
    </p>
  </section>

  <PlansOrchestrator
    mobilePlansLibre={librePlans}
    mobilePlansUltra={ultraPlans}
    mobilePlansInternet={movilInternetPlans}
    internetPlans={homePlans}
  />
</BaseLayout>
