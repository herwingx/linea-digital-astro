---
// src/components/Newsletter.astro
---

<section class="relative py-8 sm:py-12 px-4 sm:px-6">
  <div
    class="relative mx-auto max-w-7xl overflow-hidden rounded-2xl sm:rounded-[2.5rem] bg-gradient-to-br from-slate-100 via-white to-slate-50 dark:from-slate-900 dark:via-slate-900 dark:to-blue-950 shadow-2xl shadow-slate-200/50 dark:shadow-blue-900/30 ring-1 ring-slate-200 dark:ring-white/10"
  >
    <!-- 1. FONDO ATMOSF√âRICO (GLOWS) -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
      <!-- Malla de ruido sutil para textura -->
      <div
        class="absolute inset-0 opacity-20 mix-blend-overlay"
        style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMwMDAiLz4KPC9zdmc+');"
      >
      </div>

      <!-- Luces animadas -->
      <div
        class="absolute -left-20 top-0 h-[500px] w-[500px] rounded-full bg-blue-600/30 blur-[120px] animate-pulse"
      >
      </div>
      <div
        class="absolute -right-20 bottom-0 h-[400px] w-[400px] rounded-full bg-indigo-600/20 blur-[100px]"
        style="animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; animation-delay: 2s"
      >
      </div>

      <!-- Rayos de luz decorativos -->
      <div
        class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full bg-[radial-gradient(ellipse_at_top,rgba(255,255,255,0.1),transparent_70%)]"
      >
      </div>
    </div>

    <!-- 2. CONTENIDO -->
    <div
      class="relative z-10 px-4 py-12 sm:px-8 sm:py-16 lg:py-20 lg:px-20 flex flex-col lg:flex-row items-center justify-between gap-8 lg:gap-12"
    >
      <!-- Texto de Venta -->
      <div class="max-w-xl text-center lg:text-left space-y-4 sm:space-y-6">
        <!-- Badge mejorado -->
        <div
          class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-blue-500/20 to-purple-500/20 dark:from-blue-500/20 dark:to-purple-500/20 border border-blue-400/30 dark:border-blue-400/30 px-3 sm:px-4 py-1 sm:py-1.5 text-blue-600 dark:text-blue-400 text-xs font-bold uppercase tracking-widest backdrop-blur-sm"
        >
          <span class="relative flex h-2 w-2">
            <span
              class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-500 dark:bg-blue-400 opacity-75"
            ></span>
            <span
              class="relative inline-flex rounded-full h-2 w-2 bg-blue-600 dark:bg-blue-400"
            ></span>
          </span>
          üéÅ Ofertas Exclusivas
        </div>

        <h2
          class="text-3xl sm:text-4xl lg:text-5xl font-bold tracking-tighter text-slate-900 dark:text-white leading-tight"
        >
          Recibe las mejores <br class="hidden sm:block" />
          <span
            class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-cyan-500 to-indigo-600 dark:from-blue-400 dark:via-cyan-300 dark:to-indigo-300"
            >ofertas antes que nadie</span
          >
        </h2>

        <p
          class="text-base sm:text-lg leading-relaxed text-slate-600 dark:text-slate-300 max-w-lg mx-auto lg:mx-0"
        >
          √önete a nuestra comunidad y recibe alertas de promociones flash,
          nuevos equipos y descuentos de hasta <strong
            class="text-blue-600 dark:text-blue-400">40% OFF</strong
          > directo en tu correo.
        </p>

        <!-- Prueba Social (sin n√∫meros espec√≠ficos) -->
        <div
          class="flex items-center justify-center lg:justify-start gap-3 pt-2"
        >
          <div class="flex -space-x-2">
            <div
              class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 ring-2 ring-white dark:ring-slate-900 flex items-center justify-center text-white text-xs font-bold"
            >
              A
            </div>
            <div
              class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 ring-2 ring-white dark:ring-slate-900 flex items-center justify-center text-white text-xs font-bold"
            >
              M
            </div>
            <div
              class="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-400 to-cyan-600 ring-2 ring-white dark:ring-slate-900 flex items-center justify-center text-white text-xs font-bold"
            >
              J
            </div>
            <div
              class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 ring-2 ring-white dark:ring-slate-900 flex items-center justify-center text-white text-xs font-bold"
            >
              R
            </div>
          </div>
          <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400">
            <span class="text-slate-900 dark:text-white font-semibold"
              >Cientos de clientes</span
            > ya reciben nuestras ofertas
          </p>
        </div>

        <!-- Beneficios -->
        <div
          class="flex flex-wrap items-center justify-center lg:justify-start gap-3 sm:gap-4 text-xs font-medium text-slate-600 dark:text-slate-400 pt-2"
        >
          <span class="flex items-center gap-1.5"
            ><svg
              class="w-4 h-4 text-emerald-500 dark:text-emerald-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"></path></svg
            > Sin spam</span
          >
          <span class="flex items-center gap-1.5"
            ><svg
              class="w-4 h-4 text-emerald-500 dark:text-emerald-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"></path></svg
            > Cancelas cuando quieras</span
          >
          <span class="flex items-center gap-1.5"
            ><svg
              class="w-4 h-4 text-emerald-500 dark:text-emerald-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
              ></path></svg
            > 100% seguro</span
          >
        </div>
      </div>

      <!-- 3. FORMULARIO PILL (Estilo Apple) -->
      <div class="w-full max-w-md">
        <form id="newsletter-form" class="relative group">
          <!-- Contenedor Glass Unificado -->
          <div
            class="relative flex flex-col sm:flex-row items-center gap-3 rounded-xl sm:rounded-[1.5rem] bg-slate-200/50 dark:bg-white/5 border border-slate-300 dark:border-white/10 p-2 shadow-xl transition-all duration-300 focus-within:bg-slate-100 dark:focus-within:bg-white/10 focus-within:border-blue-500 dark:focus-within:border-blue-400/50 focus-within:ring-4 focus-within:ring-blue-500/20 hover:border-slate-400 dark:hover:border-white/20"
          >
            <!-- Input Email -->
            <div class="relative w-full flex items-center pl-3 sm:pl-4">
              <svg
                class="w-5 h-5 text-slate-500 dark:text-slate-400 mr-2 sm:mr-3 shrink-0"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                ></path></svg
              >
              <input
                id="email-address"
                name="email"
                type="email"
                autocomplete="email"
                required
                class="w-full bg-transparent border-0 py-3 sm:py-3.5 text-slate-900 dark:text-white placeholder:text-slate-500 dark:placeholder:text-slate-500 focus:ring-0 text-sm sm:text-sm sm:leading-6 outline-none"
                placeholder="tu@correo.com"
              />
            </div>

            <!-- Bot√≥n integrado -->
            <button
              type="submit"
              class="w-full sm:w-auto flex-none rounded-lg sm:rounded-xl bg-gradient-to-r from-blue-600 to-blue-500 px-6 sm:px-8 py-3 sm:py-3.5 text-sm font-bold text-white shadow-lg shadow-blue-600/30 transition-all hover:shadow-blue-600/50 hover:scale-[1.02] active:scale-[0.98] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-500 disabled:opacity-70 disabled:cursor-not-allowed disabled:hover:scale-100"
            >
              <span
                id="btn-text"
                class="flex items-center justify-center gap-2"
              >
                Suscribirme gratis
                <svg
                  class="w-4 h-4 hidden sm:inline"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                </svg>
              </span>
              <svg
                id="btn-spinner"
                class="w-5 h-5 hidden animate-spin mx-auto"
                fill="none"
                viewBox="0 0 24 24"
                ><circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"></circle><path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path></svg
              >
            </button>
          </div>

          <!-- Feedback Message -->
          <div
            id="newsletter-feedback"
            class="mt-3 text-xs font-medium text-center sm:text-left text-slate-600 dark:text-slate-400 transition-all opacity-0 translate-y-2 min-h-[20px]"
          >
            <!-- Inyectado por JS -->
          </div>
        </form>

        <!-- Texto de privacidad -->
        <p
          class="mt-3 sm:mt-4 text-xs text-center sm:text-left text-slate-500 dark:text-slate-500 flex items-center justify-center sm:justify-start gap-1"
        >
          <svg
            class="w-3 h-3"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
            ></path>
          </svg>
          Respetamos tu privacidad. Lee nuestra <a
            href="#"
            class="underline hover:text-slate-400 dark:hover:text-slate-300"
            >pol√≠tica de datos</a
          >.
        </p>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener("astro:page-load", () => {
    const form = document.getElementById("newsletter-form") as HTMLFormElement;
    const feedback = document.getElementById("newsletter-feedback");
    const input = document.getElementById("email-address") as HTMLInputElement;
    const btn = form?.querySelector("button");
    const btnText = document.getElementById("btn-text");
    const btnSpinner = document.getElementById("btn-spinner");

    if (!form || !btn || !btnText || !btnSpinner) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // 1. Loading State
      btn.disabled = true;
      btnText.classList.add("hidden");
      btnSpinner.classList.remove("hidden");

      // Reset feedback visual
      if (feedback) {
        feedback.className =
          "mt-3 text-xs font-medium text-center sm:text-left text-slate-400 transition-all opacity-0 translate-y-2 min-h-[20px]";
        feedback.textContent = "";
      }

      try {
        const formData = new FormData(form);

        const response = await fetch("/api/subscribe", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (response.ok) {
          // 2. Success Animation
          if (feedback) {
            feedback.innerHTML = `<span class="flex items-center justify-center sm:justify-start gap-1.5 text-emerald-400"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> ¬°Listo! Revisa tu correo para confirmar.</span>`;
            feedback.classList.remove("opacity-0", "translate-y-2");
            feedback.classList.add("opacity-100", "translate-y-0");
          }

          input.value = "";
          btn.classList.remove("from-blue-600", "to-blue-500");
          btn.classList.add(
            "from-green-500",
            "to-green-600",
            "pointer-events-none",
          );

          btnSpinner.classList.add("hidden");
          btnText.innerHTML = `<span class="flex items-center justify-center gap-2">¬°Suscrito! üéâ</span>`;
          btnText.classList.remove("hidden");

          // Reset
          setTimeout(() => {
            if (feedback) {
              feedback.classList.add("opacity-0");
              feedback.classList.remove("opacity-100");
            }
            btn.classList.remove(
              "from-green-500",
              "to-green-600",
              "pointer-events-none",
            );
            btn.classList.add("from-blue-600", "to-blue-500");
            btn.disabled = false;
            btnText.innerHTML = `Suscribirme gratis <svg class="w-4 h-4 inline ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>`;
          }, 5000);
        } else {
          throw new Error(data.message || "Error");
        }
      } catch (error) {
        // 3. Error State
        console.error(error);
        if (feedback) {
          feedback.innerHTML = `<span class="flex items-center justify-center sm:justify-start gap-1.5 text-red-400"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Algo sali√≥ mal. Intenta de nuevo.</span>`;
          feedback.classList.remove("opacity-0", "translate-y-2");
          feedback.classList.add("opacity-100", "translate-y-0");
        }
        btn.disabled = false;
        btnSpinner.classList.add("hidden");
        btnText.classList.remove("hidden");
      }
    });
  });

  // Fallback simple por si no se usan view transitions
  if (document.readyState === "complete") {
    document.dispatchEvent(new Event("astro:page-load"));
  } else {
    document.addEventListener("DOMContentLoaded", () =>
      document.dispatchEvent(new Event("astro:page-load")),
    );
  }
</script>
