---
// src/components/Newsletter.astro
// Diseño: "Deep Brand Card" - Alto contraste consistente en ambos temas.
---

<section class="relative px-4 sm:px-6 lg:px-8 py-12">
  <div
    class="relative mx-auto max-w-7xl overflow-hidden rounded-[2.5rem] bg-[#0B1120] dark:bg-[#151e2e] shadow-2xl shadow-blue-900/30 ring-1 ring-white/10 isolate"
  >
    <!-- 1. FONDO DEEP ATMOSPHERE (Optimized CSS Gradients) -->
    <div class="absolute inset-0 -z-10">
      <!-- Gradiente base Deep Navy -->
      <div
        class="absolute inset-0 bg-gradient-to-br from-[#0f172a] via-[#0B1120] to-blue-950/50"
      >
      </div>

      <!-- Glow Azul Telcel (Brand Accent) -->
      <div
        class="absolute -top-24 -left-24 h-[500px] w-[500px] rounded-full bg-blue-600/20 blur-[120px] mix-blend-screen"
      >
      </div>

      <!-- Glow Secundario Cyan -->
      <div
        class="absolute -bottom-24 -right-24 h-[500px] w-[500px] rounded-full bg-cyan-600/10 blur-[100px] mix-blend-screen"
      >
      </div>

      <!-- Malla de ruido sutil para textura "Premium" -->
      <div
        class="absolute inset-0 opacity-20 mix-blend-overlay bg-[url('https://grainy-gradients.vercel.app/noise.svg')]"
      >
      </div>
    </div>

    <!-- 2. CONTENIDO (Grid Layout) -->
    <div
      class="relative z-10 grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 px-6 py-16 sm:px-12 lg:p-20 items-center"
    >
      <!-- Columna Izquierda: Copy de Venta -->
      <div
        class="flex flex-col items-center lg:items-start text-center lg:text-left space-y-6"
      >
        <!-- Badge Exclusividad -->
        <div
          class="inline-flex items-center gap-2 rounded-full border border-blue-400/30 bg-blue-500/10 px-4 py-1.5 text-xs font-bold uppercase tracking-widest text-blue-300 backdrop-blur-md shadow-sm"
        >
          <span class="relative flex h-2 w-2">
            <span
              class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"
            ></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"
            ></span>
          </span>
          Círculo Telcel VIP
        </div>

        <h2
          class="text-4xl md:text-5xl font-bold tracking-tight text-white leading-[1.1]"
        >
          Domina tu comunicación. <br />
          <span
            class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300"
          >
            Ahorra como experto.
          </span>
        </h2>

        <p class="text-lg leading-relaxed text-slate-300 max-w-lg">
          Únete a nuestra lista exclusiva. Recibe alertas de <strong
            >iPhone 15 en oferta</strong
          >, promociones de doble de gigas y descuentos corporativos antes que
          nadie.
        </p>

        <!-- Trust Signals (Minimalistas) -->
        <div
          class="flex flex-wrap justify-center lg:justify-start gap-x-6 gap-y-3 pt-2 text-sm font-medium text-slate-400"
        >
          <span class="flex items-center gap-2">
            <svg
              class="w-5 h-5 text-emerald-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"></path></svg
            >
            Sin Spam
          </span>
          <span class="flex items-center gap-2">
            <svg
              class="w-5 h-5 text-emerald-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
              ></path></svg
            >
            Datos Seguros
          </span>
        </div>
      </div>

      <!-- Columna Derecha: Formulario de Alta Conversión -->
      <div class="w-full max-w-md mx-auto lg:mx-0">
        <form id="newsletter-form" class="relative group">
          <!-- Card del Input (Glassmorphism sobre oscuro) -->
          <div
            class="flex flex-col gap-4 p-2 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-sm shadow-xl transition-all focus-within:ring-2 focus-within:ring-blue-500/50 focus-within:bg-white/10"
          >
            <!-- Email Input -->
            <div class="relative w-full">
              <div
                class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
              >
                <svg
                  class="h-5 w-5 text-slate-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                  ></path>
                </svg>
              </div>
              <input
                id="email-address"
                name="email"
                type="email"
                autocomplete="email"
                required
                class="block w-full rounded-xl border-0 bg-transparent py-4 pl-12 pr-4 text-white placeholder:text-slate-500 focus:ring-0 sm:text-sm sm:leading-6"
                placeholder="tucorreo@empresa.com"
              />
            </div>

            <!-- Submit Button (Full Width Mobile) -->
            <button
              type="submit"
              class="flex w-full items-center justify-center rounded-xl bg-blue-600 px-8 py-3.5 text-sm font-bold text-white shadow-lg shadow-blue-600/40 hover:bg-blue-500 hover:shadow-blue-500/50 transition-all duration-300 active:scale-[0.98]"
            >
              <span id="btn-text">Quiero Acceso VIP</span>
              <svg
                id="btn-spinner"
                class="w-5 h-5 hidden animate-spin text-white/80"
                fill="none"
                viewBox="0 0 24 24"
                ><circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"></circle><path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path></svg
              >
            </button>
          </div>

          <!-- Feedback dinámico -->
          <div
            id="newsletter-feedback"
            class="absolute -bottom-8 left-0 right-0 text-center text-xs font-medium min-h-[1.5rem] transition-all duration-300 opacity-0 translate-y-2"
          >
          </div>

          <p class="mt-4 text-center text-xs text-slate-500">
            Respetamos tu privacidad. Puedes darte de baja en cualquier momento.
          </p>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  // Estado global para evitar múltiples inicializaciones
  let isInitialized = false;

  function initNewsletter() {
    if (isInitialized) return;

    const form = document.getElementById("newsletter-form") as HTMLFormElement;
    const feedback = document.getElementById("newsletter-feedback");
    const input = document.getElementById("email-address") as HTMLInputElement;
    const btn = form?.querySelector("button") as HTMLButtonElement;
    const btnText = document.getElementById("btn-text");
    const btnSpinner = document.getElementById("btn-spinner");

    if (!form || !feedback || !btn || !input || !btnText || !btnSpinner) {
      return;
    }

    isInitialized = true;

    // Función para mostrar feedback
    const showFeedback = (message: string, isSuccess: boolean) => {
      const color = isSuccess ? "text-emerald-400" : "text-red-400";
      feedback.innerHTML = `<span class="${color} font-bold">${message}</span>`;
      feedback.classList.remove("opacity-0", "translate-y-2");
      feedback.classList.add("opacity-100", "translate-y-0");
    };

    // Función para ocultar feedback
    const hideFeedback = () => {
      feedback.classList.add("opacity-0", "translate-y-2");
      feedback.classList.remove("opacity-100", "translate-y-0");
    };

    // Función para cambiar estado del botón
    const setButtonState = (loading: boolean, success?: boolean) => {
      btn.disabled = loading || success === true;

      if (loading) {
        btnText.classList.add("hidden");
        btnSpinner.classList.remove("hidden");
      } else {
        btnSpinner.classList.add("hidden");
        btnText.classList.remove("hidden");

        if (success) {
          btnText.textContent = "¡Listo!";
          btn.classList.add("bg-emerald-600");
          btn.classList.remove("bg-blue-600");
        } else {
          btnText.textContent = "Quiero Acceso VIP";
          btn.classList.remove("bg-emerald-600");
          btn.classList.add("bg-blue-600");
        }
      }
    };

    // Handler del formulario
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!input.value.trim()) return;

      // Estado de carga
      setButtonState(true);
      hideFeedback();

      try {
        const response = await fetch("/api/subscribe", {
          method: "POST",
          body: new FormData(form),
        });

        const data = await response.json();
        const isSuccess = data.success === true;

        // Mostrar resultado
        showFeedback(data.message, isSuccess);

        if (isSuccess) {
          input.value = "";
          setButtonState(false, true);

          // Restaurar después de 4 segundos
          setTimeout(() => {
            setButtonState(false, false);
            hideFeedback();
          }, 4000);
        } else {
          setButtonState(false, false);
          setTimeout(hideFeedback, 5000);
        }
      } catch (error) {
        showFeedback("Error de conexión. Intenta más tarde.", false);
        setButtonState(false, false);
        setTimeout(hideFeedback, 5000);
      }
    });
  }

  // Inicializar en carga de página
  document.addEventListener("astro:page-load", () => {
    isInitialized = false;
    initNewsletter();
  });

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initNewsletter);
  } else {
    initNewsletter();
  }
</script>
