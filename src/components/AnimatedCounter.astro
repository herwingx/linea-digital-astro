---
// src/components/AnimatedCounter.astro
interface Props {
  end: number;
  prefix?: string;
  suffix?: string;
  duration?: number;
}

const { end, prefix = '', suffix = '', duration = 2000 } = Astro.props;

// Ensure we have valid numbers
const safeEnd = Number(end) || 0;
const safeDuration = Number(duration) || 2000;

// Generate a unique ID for this counter
const counterId = `counter-${Math.random().toString(36).substr(2, 9)}`;
---

<div id={counterId} class="counter" data-end={safeEnd}>
  {prefix}0{suffix}
</div>

<script define:vars={{ counterId, safeEnd, prefix, suffix, safeDuration }}>
  // Client-side script that runs when the component mounts
  (() => {
    const element = document.getElementById(counterId);
    if (!element) return;

    let start = 0;
    const end = safeEnd;
    const duration = safeDuration;
    const startTime = performance.now();

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function animate(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // Ease-out cubic for smooth deceleration
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const currentValue = Math.floor(start + (end - start) * easeProgress);
      
      element.innerHTML = `${prefix}${formatNumber(currentValue)}${suffix}`;
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        // Ensure we end exactly on the target value
        element.innerHTML = `${prefix}${formatNumber(end)}${suffix}`;
      }
    }

    // Start animation when the element is in viewport
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          requestAnimationFrame(animate);
          observer.disconnect();
        }
      });
    }, { threshold: 0.1 });

    observer.observe(element);
  })();
</script>

<style>
.counter {
  display: inline-block;
  min-width: 60px; /* Adjust based on your needs */
}
</style>
