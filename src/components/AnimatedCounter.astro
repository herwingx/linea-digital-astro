---
// src/components/AnimatedCounter.astro
interface Props {
  end: number;
  prefix?: string;
  suffix?: string;
  duration?: number;
  class?: string; // Permite recibir clases externas (colores, tamaños)
}

const { 
  end, 
  prefix = '', 
  suffix = '', 
  duration = 2000, 
  class: className = '' 
} = Astro.props;
---

<span
  class:list={["animated-counter tabular-nums tracking-tight", className]}
  data-end={end}
  data-prefix={prefix}
  data-suffix={suffix}
  data-duration={duration}
>
  {/* Valor inicial para SEO y SSR */}
  {prefix}0{suffix}
</span>

<script>
  // Función para animar un solo elemento
  const animateValue = (obj: HTMLElement) => {
    // Evitamos re-animar si ya terminó
    if (obj.hasAttribute('data-animated')) return;
    
    const end = parseFloat(obj.dataset.end || "0");
    const duration = parseInt(obj.dataset.duration || "2000");
    const prefix = obj.dataset.prefix || "";
    const suffix = obj.dataset.suffix || "";
    
    // Usamos Intl.NumberFormat para formateo nativo y performante (localización MX/US automática)
    const formatter = new Intl.NumberFormat('es-MX'); 
    
    let startTimestamp: number | null = null;

    const step = (timestamp: number) => {
      if (!startTimestamp) startTimestamp = timestamp;
      
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      
      // Easing: easeOutQuart (más suave y "moderno" que cubic)
      const easeProgress = 1 - Math.pow(1 - progress, 4);
      
      const current = Math.floor(easeProgress * end);
      
      // Renderizado
      obj.textContent = `${prefix}${formatter.format(current)}${suffix}`;
      
      if (progress < 1) {
        window.requestAnimationFrame(step);
      } else {
        obj.textContent = `${prefix}${formatter.format(end)}${suffix}`;
        obj.setAttribute('data-animated', 'true'); // Marca para no repetir
      }
    };

    window.requestAnimationFrame(step);
  };

  // Función de inicialización (patrón Astro moderno)
  const initCounters = () => {
    const counters = document.querySelectorAll<HTMLElement>('.animated-counter');
    
    if (counters.length === 0) return;

    // Un solo IntersectionObserver para todos los contadores (Mejora de Performance)
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          animateValue(entry.target as HTMLElement);
          observer.unobserve(entry.target); // Dejar de observar una vez animado
        }
      });
    }, { threshold: 0.2 });

    counters.forEach((counter) => observer.observe(counter));
  };

  // Ejecutar en carga inicial y en navegaciones (View Transitions)
  document.addEventListener('astro:page-load', initCounters);
  // Fallback para primera carga si no se usa view transitions
  document.addEventListener('DOMContentLoaded', initCounters); 
</script>

<style>
  /* "tabular-nums" es CRUCIAL para Clean UI.
     Hace que todos los números (1, 7, 9) ocupen el mismo ancho,
     evitando que el texto vibre o salte mientras cuenta. */
  .tabular-nums {
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
  }
</style>