---
// src/components/AnimatedCounter.astro
interface Props {
  end: number;
  prefix?: string;
  suffix?: string;
  duration?: number;
  decimals?: number;
  class?: string;
}

const {
  end,
  prefix = "",
  suffix = "",
  duration = 2000,
  decimals = 0,
  class: className = "",
} = Astro.props;
---

<div
  class:list={["animated-counter", className]}
  data-end={end}
  data-prefix={prefix}
  data-suffix={suffix}
  data-duration={duration}
  data-decimals={decimals}
  role="status"
  aria-live="assertive"
  aria-atomic="true"
>
  {/* Render inicial estático para SEO y fallback */}
  {prefix}{
    end.toLocaleString("es-MX", {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals,
    })
  }{suffix}
</div>

<script>
  const initCounters = () => {
    // 1. Detectar preferencia de usuario para reducir movimiento
    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)",
    ).matches;
    const counters =
      document.querySelectorAll<HTMLElement>(".animated-counter");

    if (counters.length === 0) return;
    if (prefersReducedMotion) return; // Si prefiere no animar, dejamos el valor inicial (SEO friendly)

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            animateValue(entry.target as HTMLElement);
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.2 },
    );

    counters.forEach((counter) => observer.observe(counter));
  };

  const animateValue = (obj: HTMLElement) => {
    if (obj.dataset.animated) return; // Evitar doble animación

    const end = parseFloat(obj.dataset.end || "0");
    const duration = parseInt(obj.dataset.duration || "2000");
    const prefix = obj.dataset.prefix || "";
    const suffix = obj.dataset.suffix || "";
    const decimals = parseInt(obj.dataset.decimals || "0");

    let startTimestamp: number | null = null;

    // Configuración regional
    const formatter = new Intl.NumberFormat("es-MX", {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals,
    });

    const step = (timestamp: number) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);

      // Easing: easeOutExpo (Sensación más "snappy" y tecnológica)
      const easeProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);

      const current = easeProgress * end;
      obj.textContent = `${prefix}${formatter.format(current)}${suffix}`;

      if (progress < 1) {
        window.requestAnimationFrame(step);
      } else {
        // Asegurar valor final exacto
        obj.textContent = `${prefix}${formatter.format(end)}${suffix}`;
        obj.dataset.animated = "true";
      }
    };

    // Comenzar en 0 visualmente
    obj.textContent = `${prefix}${formatter.format(0)}${suffix}`;
    window.requestAnimationFrame(step);
  };

  document.addEventListener("astro:page-load", initCounters);
  document.addEventListener("DOMContentLoaded", initCounters);
</script>

<style>
  /* Clave para UI numérica estable */
  .animated-counter {
    font-variant-numeric: tabular-nums; /* Ancho fijo por número */
    font-feature-settings: "tnum";
    white-space: nowrap; /* Evitar roturas */
    will-change: contents;
  }
</style>
