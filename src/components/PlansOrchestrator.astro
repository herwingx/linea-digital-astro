---
import GenericPlanCarousel from "./GenericPlanCarousel.astro";

interface Props {
  mobilePlansLibre: any[];
  mobilePlansUltra: any[];
  mobilePlansInternet: any[];
  internetPlans: any[];
  title?: string;
  subtitle?: string;
}

const {
  mobilePlansLibre,
  mobilePlansUltra,
  mobilePlansInternet,
  internetPlans,
  title,
  subtitle,
} = Astro.props;
---

<section class="w-full py-2 overflow-hidden">
  <div class="container mx-auto px-4 max-w-6xl">
    <!-- Header -->
    <div class="text-center mb-10">
      <h2
        class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-white mb-4"
      >
        {title}
      </h2>
      <p class="text-lg text-slate-500 dark:text-slate-400">{subtitle}</p>
    </div>

    <!-- Main Tabs -->
    <div class="flex justify-center mb-12 py-4">
      <div
        class="relative inline-flex p-1 bg-slate-100 dark:bg-slate-800/50 rounded-full border border-slate-200 dark:border-slate-700/50"
      >
        <div
          id="main-glider"
          class="absolute left-1 top-1 bottom-1 w-[calc(50%-8px)] bg-white dark:bg-slate-700 rounded-full shadow transition-transform duration-300 ease-out"
        >
        </div>
        <button
          onclick="switchMain('movil')"
          id="tab-movil"
          class="relative z-10 w-32 py-2 text-sm font-bold uppercase tracking-wider text-blue-600 dark:text-white"
          >Telefonía</button
        >
        <button
          onclick="switchMain('hogar')"
          id="tab-hogar"
          class="relative z-10 w-32 py-2 text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 hover:text-slate-700"
          >Internet</button
        >
      </div>
    </div>

    <div id="planes-content" class="relative min-h-[600px]">
      <!-- MOVIL VIEW -->
      <div
        id="view-movil"
        class="absolute w-full transition-all duration-500 opacity-100 z-10"
      >
        <!-- Subtabs -->
        <div class="flex justify-center gap-3 mb-8">
          {
            ["libre", "ultra", "internet"].map((type, idx) => (
              <button
                onclick={`switchSub('${type}')`}
                data-type={type}
                class={`sub-tab px-5 py-2 rounded-full border text-xs font-bold uppercase transition-all ${idx === 0 ? "bg-blue-50 border-blue-200 text-blue-600 dark:bg-blue-900/20 dark:text-blue-300 shadow-sm scale-105" : "border-transparent text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800"}`}
              >
                {type === "libre"
                  ? "Planes Libre"
                  : type === "ultra"
                    ? "Ultra 5G"
                    : "Internet Móvil"}
              </button>
            ))
          }
        </div>

        <GenericPlanCarousel id="libre" plans={mobilePlansLibre} />
        <GenericPlanCarousel
          id="ultra"
          plans={mobilePlansUltra}
          isHidden={true}
        />
        <GenericPlanCarousel
          id="internet"
          plans={mobilePlansInternet}
          isHidden={true}
        />
      </div>

      <!-- HOGAR VIEW -->
      <div
        id="view-hogar"
        class="absolute w-full transition-all duration-500 opacity-0 translate-x-12 pointer-events-none z-0"
      >
        <div class="text-center mb-8 opacity-60">
          <span class="text-xs font-bold uppercase tracking-widest"
            >Internet Residencial 4G/5G</span
          >
        </div>
        <GenericPlanCarousel id="hogar" plans={internetPlans} />
      </div>
    </div>
  </div>
</section>

<script>
  import Swiper from "swiper";
  import { Navigation, Pagination, EffectCoverflow } from "swiper/modules";
  import "swiper/css";
  import "swiper/css/navigation";
  import "swiper/css/pagination";

  // GLOBAL TYPES
  declare global {
    interface Window {
      switchMain: (c: string) => void;
      switchSub: (t: string) => void;
    }
    interface HTMLElement {
      swiper?: Swiper;
    }
  }

  // STATE
  let currMain = "movil";
  let currSub = "libre";

  window.switchMain = (cat) => {
    if (currMain === cat) return;
    currMain = cat;

    const glider = document.getElementById("main-glider");
    const movil = document.getElementById("view-movil");
    const hogar = document.getElementById("view-hogar");
    const tm = document.getElementById("tab-movil");
    const th = document.getElementById("tab-hogar");

    if (!glider || !movil || !hogar) return;

    if (cat === "movil") {
      glider.style.transform = "translateX(0)";
      setColors(tm, true);
      setColors(th, false);
      crossfade(hogar, movil);
      refreshSwiper(currSub);
    } else {
      glider.style.transform = "translateX(100%) translateX(8px)";
      setColors(tm, false);
      setColors(th, true);
      crossfade(movil, hogar);
      refreshSwiper("hogar");
    }
  };

  window.switchSub = (type) => {
    if (currSub === type) return;
    const old = currSub;
    currSub = type;

    document.querySelectorAll(".sub-tab").forEach((b) => {
      const t = b.getAttribute("data-type");
      if (t === type)
        b.className =
          "sub-tab px-5 py-2 rounded-full border text-xs font-bold uppercase transition-all bg-blue-50 border-blue-200 text-blue-600 dark:bg-blue-900/20 dark:text-blue-300 shadow-sm scale-105";
      else
        b.className =
          "sub-tab px-5 py-2 rounded-full border text-xs font-bold uppercase transition-all border-transparent text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800";
    });

    const cOld = document.getElementById(`container-${old}`);
    const cNew = document.getElementById(`container-${type}`);

    if (cOld && cNew) {
      cOld.classList.add("hidden", "opacity-0");
      cOld.classList.remove("relative", "opacity-100");

      cNew.classList.remove(
        "hidden",
        "opacity-0",
        "absolute",
        "translate-y-12",
      );
      cNew.classList.add("relative", "opacity-100", "translate-y-0");

      refreshSwiper(type);
    }
  };

  // HELPERS
  function setColors(el: HTMLElement | null, active: boolean) {
    if (!el) return;
    el.className = active
      ? "relative z-10 w-32 py-2 text-sm font-bold uppercase tracking-wider text-blue-600 dark:text-white transition-colors"
      : "relative z-10 w-32 py-2 text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 hover:text-slate-700 transition-colors";
  }

  function crossfade(outEl: HTMLElement, inEl: HTMLElement) {
    outEl.style.opacity = "0";
    outEl.style.transform = "translateX(50px)";
    outEl.style.pointerEvents = "none";
    outEl.style.zIndex = "0"; // Bajar z-index al salir

    setTimeout(() => {
      outEl.classList.add("absolute");
      outEl.classList.remove("relative");

      inEl.classList.remove("absolute", "translate-x-12");
      inEl.classList.add("relative");
      // Reflow force
      void inEl.offsetWidth;
      inEl.style.opacity = "1";
      inEl.style.transform = "translateX(0)";
      inEl.style.pointerEvents = "auto";
      inEl.style.zIndex = "20"; // Subir z-index al entrar
    }, 300);
  }

  function refreshSwiper(id: string) {
    setTimeout(() => {
      const el = document.querySelector(
        `#container-${id} .swiper`,
      ) as HTMLElement;
      if (el) {
        // DESTRUIR Y RECREAR: La solución definitiva para glitches de loop
        if ((el as any).swiper) {
          (el as any).swiper.destroy(true, true);
        }
        init(el);
      }
    }, 50);
  }

  // INIT
  function init(specificEl?: HTMLElement) {
    const elements = specificEl
      ? [specificEl]
      : document.querySelectorAll(".swiper");

    elements.forEach((el) => {
      if ((el as any).swiper) return; // Ya inicializado

      const id = el.getAttribute("data-config-id");
      const startIdx = parseInt(el.getAttribute("data-initial-slide") || "0");

      new Swiper(el as HTMLElement, {
        modules: [Navigation, Pagination, EffectCoverflow],
        loop: true,
        centeredSlides: true,
        initialSlide: startIdx,
        slidesPerView: "auto",
        spaceBetween: 0,
        speed: 600,
        observer: true,
        observeParents: true,

        breakpoints: {
          320: { spaceBetween: 16 },
          640: { spaceBetween: 12 },
          1024: { spaceBetween: 0 },
        },

        navigation: { nextEl: `.next-${id}`, prevEl: `.prev-${id}` },
        pagination: { el: ".swiper-pagination", clickable: true },
      });
    });
  }

  document.addEventListener("astro:page-load", () => init());
  document.addEventListener("DOMContentLoaded", () => init());
</script>

<style>
  /* --- STYLE INJECTION PARA EL EFECTO FOCUS REAL --- */

  /* CONTROL DE ANCHO DE SLIDES */
  /* Esto asegura que solo se vean 3 elementos máximo */
  :global(.swiper-slide) {
    width: 300px !important; /* Ancho fijo para mobile */
    max-width: 300px;
  }

  @media (min-width: 640px) {
    :global(.swiper-slide) {
      width: 360px !important; /* Ancho para tablet */
      max-width: 360px;
    }
  }

  @media (min-width: 1024px) {
    :global(.swiper) {
      max-width: 1050px; /* 350px * 3 = Exactamente 3 tarjetas */
      margin: 0 auto;
    }
    :global(.swiper-slide) {
      width: 350px !important; /* Ajustado para que quepan 3 perfectos con aire */
      max-width: 350px;
    }
  }

  /* 1. BASE (INACTIVO - LATERALES) */
  /* Aplicamos opacidad y blur a todo, EXCEPTO al activo */
  :global(.swiper-slide .plan-card-inner) {
    transform: scale(0.85);
    filter: blur(2px) grayscale(60%);
    opacity: 0.6;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-color: transparent;
  }

  /* Botón y Badge ocultos/apagados en inactivos */
  :global(.swiper-slide:not(.swiper-slide-active) .card-badge) {
    opacity: 0;
  }
  :global(.swiper-slide:not(.swiper-slide-active) .card-btn) {
    background-color: #f1f5f9 !important; /* Slate 100 */
    color: #94a3b8 !important;
    cursor: default;
    pointer-events: none; /* No click */
    box-shadow: none;
  }

  /* 2. ACTIVE (CENTRAL) */
  :global(.swiper-slide-active) {
    z-index: 20;
  }

  :global(.swiper-slide-active .plan-card-inner) {
    transform: scale(1.05) translateY(-10px);
    filter: blur(0) grayscale(0);
    opacity: 1;
    background-color: white;
    border-color: #3b82f6; /* Blue 500 */
    box-shadow: 0 25px 50px -12px rgba(59, 130, 246, 0.25);
  }

  /* Mostrar elementos del activo */
  :global(.swiper-slide-active .card-glow) {
    opacity: 1;
  }
  :global(.swiper-slide-active .card-badge) {
    opacity: 1;
    transition-delay: 0.2s;
  }

  /* Colorear partes internas al activar */
  :global(.swiper-slide-active .card-icon) {
    background-color: #eff6ff; /* Blue 50 */
    color: #2563eb;
  }

  :global(.swiper-slide-active .card-btn) {
    background-color: #2563eb;
    color: white;
    cursor: pointer;
    pointer-events: auto;
  }

  /* DARK MODE OVERRIDES (Usando :global(.dark ...)) */
  :global(.dark .swiper-slide-active .plan-card-inner) {
    background-color: #1e293b; /* Slate 800 */
    border-color: #3b82f6;
    box-shadow: 0 25px 50px -12px rgba(37, 99, 235, 0.4);
  }

  /* Pagination Styling */
  :global(.swiper-pagination-bullet) {
    width: 8px;
    height: 8px;
    opacity: 0.4;
  }
  :global(.swiper-pagination-bullet-active) {
    background: #2563eb;
    width: 24px;
    border-radius: 4px;
    opacity: 1;
  }
</style>
