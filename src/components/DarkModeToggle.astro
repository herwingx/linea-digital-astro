<!-- src/components/DarkModeToggle.astro -->
<div class="flex items-center justify-center">
  <label
    for="darkToggler"
    class="relative inline-flex h-9 w-16 cursor-pointer items-center rounded-full border border-slate-200 bg-slate-100 p-1 shadow-inner transition-colors duration-300 focus-within:ring-2 focus-within:ring-blue-500 focus-within:ring-offset-2 hover:border-blue-200 dark:border-slate-700 dark:bg-slate-800 dark:hover:border-slate-600"
    aria-label="Alternar modo oscuro"
  >
    <input
      type="checkbox"
      name="darkToggler"
      id="darkToggler"
      class="peer sr-only"
    />

    <!-- TRACK BACKGROUND ICONS (Decorativos y sutiles) -->
    <span
      class="absolute left-2.5 text-2xs text-slate-300 dark:text-slate-600"
    >
      <!-- Sun placeholder outline for track -->
      <svg
        width="14"
        height="14"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="3"><circle cx="12" cy="12" r="5"></circle></svg
      >
    </span>
    <span
      class="absolute right-2.5 text-2xs text-slate-300 dark:text-slate-600"
    >
      <!-- Moon placeholder outline for track -->
      <svg
        width="14"
        height="14"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="3"
        ><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg
      >
    </span>

    <!-- KNOB (La pieza que se desliza) -->
    <!-- El knob se mueve usando peer-checked:translate-x -->
    <div
      class="relative z-10 flex h-7 w-7 transform items-center justify-center rounded-full bg-white text-blue-600 shadow-md ring-1 ring-black/5 transition-all duration-500 ease-[cubic-bezier(0.23,1,0.32,1)] peer-checked:translate-x-7 dark:bg-slate-700 dark:text-blue-400 dark:ring-white/10"
    >
      <!-- SUN ICON (Visible in Light) -->
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="absolute h-4 w-4 transform transition-all duration-500 peer-checked:rotate-90 peer-checked:scale-0 opacity-100 rotate-0 dark:scale-0 dark:opacity-0"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>

      <!-- MOON ICON (Visible in Dark) -->
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="absolute h-4 w-4 transform transition-all duration-500 scale-0 -rotate-90 opacity-0 dark:scale-100 dark:rotate-0 dark:opacity-100"
        viewBox="0 0 24 24"
        fill="currentColor"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </div>
  </label>
</div>

<script is:inline>
  (function () {
    // Función aislada para evitar colisiones
    function setupTheme() {
      const toggler = document.getElementById("darkToggler");
      const html = document.documentElement;

      // 1. Obtener Preferencia Actual
      const getTheme = () => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          return "dark";
        }
        return "light";
      };

      // 2. Aplicar Estado Visual al Input y al HTML
      const updateTheme = (theme) => {
        if (theme === "dark") {
          html.classList.add("dark");
          if (toggler) toggler.checked = true;
        } else {
          html.classList.remove("dark");
          if (toggler) toggler.checked = false;
        }
        localStorage.setItem("theme", theme);
      };

      // Inicializar inmediatamente
      updateTheme(getTheme());

      // 3. Escuchar Eventos (si el DOM ya cargó el input)
      if (toggler) {
        toggler.addEventListener("change", (e) => {
          const newTheme = e.target.checked ? "dark" : "light";
          updateTheme(newTheme);
        });
      }
    }

    // Ejecutar Setup
    setupTheme();

    // Opcional: Re-ejecutar en 'astro:after-swap' si usas ViewTransitions en el futuro
    document.addEventListener("astro:after-swap", setupTheme);
  })();
</script>
