---
import { Image } from "astro:assets";
import logoWhite from "../assets/logo-white.svg";
import logoDark from "../assets/logo-dark.svg";
import DarkModeToggle from "./DarkModeToggle.astro";

const { pathname } = Astro.url;
const isActive = (href: string) => {
  if (href === "/" && pathname === "/") return true;
  return href !== "/" && pathname.startsWith(href);
};

const navLinks = [
  { label: "Personas", href: "/personas" },
  { label: "Empresas", href: "/empresas" },
  { label: "Promociones", href: "/promociones" },
  { label: "Nosotros", href: "/nosotros" },
  { label: "Asociados", href: "/asociados" },
  { label: "Contacto", href: "/contacto" },
];
---

<!-- 
  HEADER MEJORADO
  - Transition suave de altura y fondo al hacer scroll
  - Glassmorphism premium
-->
<header
  id="main-header"
  class="fixed top-0 z-[999] w-full transition-all duration-500 border-b border-transparent"
>
  <!-- Fondo dinámico (se activa con JS) -->
  <div
    id="header-bg"
    class="absolute inset-0 bg-white/0 dark:bg-slate-950/0 backdrop-blur-[0px] transition-all duration-500 -z-10"
  >
  </div>

  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <nav
      class="relative flex items-center justify-between h-20 lg:h-24 transition-all duration-500"
      id="nav-container"
    >
      <!-- 1. LOGO AREA -->
      <div
        class="flex-shrink-0 z-50 transition-transform hover:scale-105 duration-300"
      >
        <a href="/" class="block" aria-label="Ir al inicio">
          <Image
            src={logoWhite}
            alt="Grupo Linea Digital Logo"
            class="w-32 sm:w-36 md:w-40 h-auto hidden dark:block drop-shadow-lg transition-all duration-300"
            loading="eager"
          />
          <Image
            src={logoDark}
            alt="Grupo Linea Digital Logo"
            class="w-32 sm:w-36 md:w-40 h-auto dark:hidden transition-all duration-300"
            loading="eager"
          />
        </a>
      </div>

      <!-- 2. MENÚ DESKTOP (CENTRADO & FLOTANTE) -->
      <div
        class="hidden lg:flex absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2"
      >
        <!-- Pill Container con fondo sutil -->
        <ul
          class="flex items-center gap-1 py-1.5 rounded-full bg-white/50 dark:bg-slate-900/30 border border-white/20 dark:border-white/5 backdrop-blur-sm shadow-sm transition-all duration-300 hover:shadow-md hover:bg-white/80 dark:hover:bg-slate-900/60"
        >
          {
            navLinks.map((link) => {
              const active = isActive(link.href);
              return (
                <li>
                  <a
                    href={link.href}
                    class={`
                    relative px-5 py-2 rounded-full text-sm font-bold transition-all duration-300
                    ${
                      active
                        ? "bg-white dark:bg-slate-800 text-blue-600 dark:text-blue-400 shadow-sm"
                        : "text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-300 hover:bg-white/50 dark:hover:bg-white/5"
                    }
                  `}
                  >
                    {link.label}
                  </a>
                </li>
              );
            })
          }
        </ul>
      </div>

      <!-- 3. ACCIONES DERECHA -->
      <div class="flex items-center gap-3 sm:gap-4 z-50">
        <!-- Toggle -->
        <div
          class="rounded-full p-1 hover:bg-slate-100/50 dark:hover:bg-slate-800/50 transition-colors backdrop-blur-sm"
        >
          <DarkModeToggle />
        </div>

        <!-- Botón Mi Telcel (Glassy Premium) -->
        <a
          target="_blank"
          href="https://www.mitelcel.com/mitelcel/login"
          class="group hidden lg:inline-flex items-center justify-center rounded-full bg-slate-900/90 dark:bg-white/90 px-6 py-2.5 text-center text-sm font-bold text-white dark:text-slate-900 shadow-lg shadow-slate-900/20 backdrop-blur-md transition-all duration-300 hover:scale-105 hover:bg-blue-600 dark:hover:bg-blue-50 hover:shadow-blue-600/30"
        >
          Mi Telcel
          <svg
            class="w-4 h-4 ml-2 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg
          >
        </a>

        <!-- Botón Hamburguesa Mejorado -->
        <button
          id="navbarToggler"
          class="relative block lg:hidden group focus:outline-none"
          aria-label="Toggle navigation"
        >
          <div
            class="relative flex overflow-hidden items-center justify-center rounded-full w-[50px] h-[50px] transform transition-all bg-slate-100/80 dark:bg-slate-800/80 ring-0 ring-blue-500/30 hover:ring-8 group-[.active]:ring-4 ring-opacity-30 duration-200 shadow-md backdrop-blur-sm"
          >
            <div
              class="flex flex-col justify-between w-[20px] h-[20px] transform transition-all duration-300 origin-center overflow-hidden"
            >
              <!-- Líneas del hamburguesa -->
              <div
                class="hamburger-line-1 bg-slate-700 dark:bg-white h-[2px] w-7 transform transition-all duration-300 origin-left"
              >
              </div>
              <div
                class="hamburger-line-2 bg-slate-700 dark:bg-white h-[2px] w-7 rounded transform transition-all duration-300"
              >
              </div>
              <div
                class="hamburger-line-3 bg-slate-700 dark:bg-white h-[2px] w-7 transform transition-all duration-300 origin-left"
              >
              </div>

              <!-- X cuando está abierto -->
              <div
                class="hamburger-x absolute items-center justify-between transform transition-all duration-500 top-2.5 -translate-x-10 flex w-0"
              >
                <div
                  class="hamburger-x-1 absolute bg-slate-700 dark:bg-white h-[2px] w-5 transform transition-all duration-500 rotate-0 delay-300"
                >
                </div>
                <div
                  class="hamburger-x-2 absolute bg-slate-700 dark:bg-white h-[2px] w-5 transform transition-all duration-500 -rotate-0 delay-300"
                >
                </div>
              </div>
            </div>
          </div>
        </button>
      </div>

      <!-- 4. MENÚ MÓVIL -->
      <div
        id="navbarCollapse"
        class="hidden absolute top-full right-0 mt-4 w-80 lg:hidden origin-top-right z-[10000] px-4"
      >
        <div
          class="rounded-[2rem] border border-slate-200/80 bg-white/90 dark:bg-slate-900/90 dark:border-slate-700 p-4 shadow-2xl shadow-blue-900/20 backdrop-blur-xl ring-1 ring-black/5"
        >
          <ul class="flex flex-col space-y-1">
            {
              navLinks.map((link) => {
                const active = isActive(link.href);
                return (
                  <li>
                    <a
                      href={link.href}
                      class={`
                        flex items-center w-full px-5 py-4 rounded-2xl text-base font-bold transition-all duration-200
                        ${
                          active
                            ? "bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300"
                            : "text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-blue-600"
                        }
                      `}
                    >
                      {link.label}
                      {active && (
                        <div class="ml-auto w-2 h-2 rounded-full bg-blue-500" />
                      )}
                    </a>
                  </li>
                );
              })
            }
            <li
              class="pt-4 mt-2 border-t border-slate-100 dark:border-slate-800"
            >
              <a
                target="_blank"
                href="https://www.mitelcel.com/mitelcel/login"
                class="flex items-center justify-center w-full bg-slate-900 text-white px-4 py-4 rounded-2xl font-bold text-sm shadow-lg shadow-slate-900/20 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 dark:bg-white dark:text-slate-900"
              >
                Ingresar a Mi Telcel
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </div>
</header>

<style>
  /* Animación del botón hamburguesa cuando está activo */
  #navbarToggler.active .hamburger-line-1 {
    transform: translate(0, 6px);
    opacity: 0;
  }

  #navbarToggler.active .hamburger-line-2 {
    transform: translate(0, 6px);
    opacity: 0;
  }

  #navbarToggler.active .hamburger-line-3 {
    transform: translate(0, 6px);
    opacity: 0;
  }

  #navbarToggler.active .hamburger-x {
    transform: translateX(0);
    width: 3rem;
  }

  #navbarToggler.active .hamburger-x-1 {
    transform: rotate(45deg);
  }

  #navbarToggler.active .hamburger-x-2 {
    transform: rotate(-45deg);
  }
</style>

<script is:inline>
  // --- SCROLL EFFECT ---
  const header = document.getElementById("main-header");
  const headerBg = document.getElementById("header-bg");
  const navContainer = document.getElementById("nav-container");

  function updateHeader() {
    if (!header || !headerBg || !navContainer) return;

    if (window.scrollY > 20) {
      // Scrolled State
      headerBg.classList.remove(
        "bg-white/0",
        "dark:bg-slate-950/0",
        "backdrop-blur-[0px]",
      );
      headerBg.classList.add(
        "bg-white/80",
        "dark:bg-slate-950/80",
        "backdrop-blur-md",
        "shadow-sm",
      );
      header.classList.add("border-slate-200/60", "dark:border-slate-800/60");
      header.classList.remove("border-transparent");

      // Compact Nav
      navContainer.classList.remove("h-20", "lg:h-24");
      navContainer.classList.add("h-16", "lg:h-20");
    } else {
      // Top State
      headerBg.classList.add(
        "bg-white/0",
        "dark:bg-slate-950/0",
        "backdrop-blur-[0px]",
      );
      headerBg.classList.remove(
        "bg-white/80",
        "dark:bg-slate-950/80",
        "backdrop-blur-md",
        "shadow-sm",
      );
      header.classList.remove(
        "border-slate-200/60",
        "dark:border-slate-800/60",
      );
      header.classList.add("border-transparent");

      // Expanded Nav
      navContainer.classList.add("h-20", "lg:h-24");
      navContainer.classList.remove("h-16", "lg:h-20");
    }
  }

  window.addEventListener("scroll", updateHeader);
  // Init on load
  document.addEventListener("DOMContentLoaded", updateHeader);

  // --- MOBILE MENU LOGIC ---
  const navbarToggler = document.getElementById("navbarToggler");
  const navbarCollapse = document.getElementById("navbarCollapse");

  if (navbarToggler && navbarCollapse) {
    let isOpen = false;

    const toggleMenu = (open) => {
      isOpen = open;
      if (isOpen) {
        navbarCollapse.classList.remove("hidden");
        navbarToggler.classList.add("active");
        navbarToggler.setAttribute("aria-expanded", "true");
      } else {
        navbarCollapse.classList.add("hidden");
        navbarToggler.classList.remove("active");
        navbarToggler.setAttribute("aria-expanded", "false");
      }
    };

    navbarToggler.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMenu(!isOpen);
    });

    // Close on click outside
    document.addEventListener("click", (e) => {
      if (
        !navbarCollapse.contains(e.target) &&
        !navbarToggler.contains(e.target) &&
        isOpen
      ) {
        toggleMenu(false);
      }
    });

    // Close on link click
    const navLinks = navbarCollapse.querySelectorAll("a");
    navLinks.forEach((link) => {
      link.addEventListener("click", () => {
        toggleMenu(false);
      });
    });

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && isOpen) {
        toggleMenu(false);
      }
    });
  }
</script>
