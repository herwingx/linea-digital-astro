---
// src/components/Header.astro
import { Image } from "astro:assets";
import logoWhite from "../assets/logo-white.svg";
import logoDark from "../assets/logo-dark.svg";
import DarkModeToggle from "./DarkModeToggle.astro";

// Definición de tipos para los enlaces
interface NavLink {
  label: string;
  href: string;
  desc?: string;
  icon?: string;
  children?: NavLink[];
}

const { pathname } = Astro.url;

const isActive = (href: string) => {
  if (href === "/" && pathname === "/") return true;
  if (href !== "/" && pathname.startsWith(href)) return true;
  return false;
};

const navLinks: NavLink[] = [
  {
    label: "Planes",
    href: "/personas",
    children: [
      { 
        label: "Personas", 
        href: "/personas", 
        desc: "Datos, Redes Sociales",
        icon: "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" 
      },
      { 
        label: "Empresas", 
        href: "/empresas", 
        desc: "Soluciones Empresariales",
        icon: "M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
      },
    ]
  },
  { label: "Promociones", href: "/promociones" },
  { label: "Asociados", href: "/asociados" },
  { label: "Nosotros", href: "/nosotros" },
  { label: "Contacto", href: "/contacto" },
];
---

<header
  id="main-header"
  class="fixed top-0 left-0 w-full z-[100] transition-all duration-500"
  data-scroll-initialized="false"
>
  <!-- Background Backdrop Inteligente -->
  <div 
    id="header-bg" 
    class="absolute inset-0 bg-transparent backdrop-blur-[0px] border-b border-transparent transition-all duration-500 -z-10"
  ></div>

  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="relative flex items-center justify-between h-20 transition-all duration-500" id="header-container">
        
      <!-- 1. LOGO BRANDING -->
      <div class="flex-shrink-0 relative z-[110]">
        <a href="/" class="block group" aria-label="Volver al inicio">
           <Image src={logoWhite} alt="Línea Digital Telcel" class="w-40 md:w-44 h-auto hidden dark:block transition-transform duration-300 group-hover:scale-105" loading="eager" />
           <Image src={logoDark} alt="Línea Digital Telcel" class="w-40 md:w-44 h-auto dark:hidden transition-transform duration-300 group-hover:scale-105" loading="eager" />
        </a>
      </div>

      <!-- 2. DESKTOP NAV ("Dynamic Island" Style) -->
      <nav class="hidden lg:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-20">
        <ul class="flex items-center gap-1 p-1.5 rounded-full bg-white/90 dark:bg-[#0B1120]/80 backdrop-blur-xl border border-slate-200/60 dark:border-white/10 shadow-lg shadow-slate-200/20 dark:shadow-black/30 ring-1 ring-black/5 dark:ring-white/5 transition-colors duration-300">
           {navLinks.map((link) => {
               const hasChildren = link.children && link.children.length > 0;
               const isChildActive = hasChildren && link.children?.some(c => isActive(c.href));
               const active = isActive(link.href) || isChildActive;

               return (
                   <li class="relative group">
                       <a 
                        href={link.href} 
                        class={`
                            relative flex items-center gap-1.5 px-5 py-2 rounded-full text-sm font-bold transition-all duration-300
                            ${active 
                                ? 'bg-slate-900 text-white shadow-md dark:bg-white dark:text-slate-900' 
                                : 'text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-white hover:bg-slate-100/50 dark:hover:bg-white/5'}
                        `}
                       >
                           {link.label}
                           {hasChildren && (
                             <svg class={`w-3 h-3 opacity-60 transition-transform duration-300 group-hover:rotate-180 ${active ? 'text-white dark:text-slate-900' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                           )}
                       </a>
                       
                       {/* Dropdown Desktop Refactorizado (Diseño Premium) */}
                       {hasChildren && (
                           <div class="absolute top-full left-1/2 -translate-x-1/2 pt-4 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 ease-[cubic-bezier(0.34,1.56,0.64,1)] transform origin-top scale-95 group-hover:scale-100 translate-y-2 group-hover:translate-y-0 z-50">
                               <!-- Puntero visual más sutil y del mismo color que el fondo oscuro -->
                               <div class="absolute top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white dark:bg-[#0B1120] rotate-45 border-t border-l border-slate-200 dark:border-white/10 z-20"></div>
                               
                               <!-- Caja del Menú (Fondo ajustado al tema Deep Navy) -->
                               <div class="relative bg-white/95 dark:bg-[#0B1120]/95 backdrop-blur-2xl rounded-2xl shadow-2xl border border-slate-200 dark:border-white/10 p-2 ring-1 ring-black/5 dark:ring-white/5 z-10 overflow-hidden">
                                   {link.children?.map(child => (
                                       <a href={child.href} class="group/item flex items-start gap-3 p-3 rounded-xl hover:bg-blue-50 dark:hover:bg-white/5 transition-all duration-200">
                                           <div class="mt-0.5 flex-shrink-0 w-9 h-9 rounded-lg bg-blue-100/50 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400 flex items-center justify-center group-hover/item:scale-110 group-hover/item:bg-blue-600 group-hover/item:text-white transition-all duration-300 shadow-sm">
                                               <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={child.icon || "M13 10V3L4 14h7v7l9-11h-7z"}/>
                                               </svg>
                                           </div>
                                           <div>
                                               <div class="text-sm font-bold text-slate-900 dark:text-white group-hover/item:text-blue-700 dark:group-hover/item:text-blue-300 transition-colors">{child.label}</div>
                                               <div class="text-[11px] text-slate-500 dark:text-slate-400 mt-0.5 leading-tight">{child.desc}</div>
                                           </div>
                                       </a>
                                   ))}
                               </div>
                           </div>
                       )}
                   </li>
               );
           })}
        </ul>
      </nav>

      <!-- 3. ACTIONS -->
      <div class="flex items-center gap-3 relative z-[110]">
         <div class="hidden sm:block hover:scale-110 transition-transform"><DarkModeToggle /></div>
         
         <a 
            href="https://www.mitelcel.com/mitelcel/login" 
            target="_blank" 
            rel="noopener noreferrer"
            class="hidden lg:inline-flex items-center justify-center px-5 py-2 text-sm font-bold transition-all rounded-full 
                   bg-transparent border border-slate-300 text-slate-700 hover:border-blue-600 hover:text-blue-600 hover:bg-blue-50
                   dark:border-white/20 dark:text-white dark:hover:border-blue-400 dark:hover:bg-blue-900/20 dark:hover:text-blue-300"
         >
            <span class="mr-2">Mi Telcel</span>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
         </a>

         <!-- Hamburger Button -->
         <button 
            id="mobile-menu-btn"
            class="lg:hidden relative z-50 w-10 h-10 flex items-center justify-center rounded-full transition-all duration-300 focus:outline-none touch-manipulation
                   bg-white/80 dark:bg-white/10 backdrop-blur-md border border-slate-200 dark:border-white/10 shadow-sm
                   active:scale-90"
            aria-label="Abrir menú"
            aria-expanded="false"
         >
             <div class="w-5 h-3.5 flex flex-col justify-between relative overflow-visible pointer-events-none">
                 <span class="w-full h-0.5 bg-slate-900 dark:bg-white rounded-full transition-all duration-300 ease-[cubic-bezier(0.68,-0.6,0.32,1.6)] origin-center ham-line-1"></span>
                 <span class="w-full h-0.5 bg-slate-900 dark:bg-white rounded-full transition-all duration-300 ease-[cubic-bezier(0.68,-0.6,0.32,1.6)] ham-line-2"></span>
                 <span class="w-full h-0.5 bg-slate-900 dark:bg-white rounded-full transition-all duration-300 ease-[cubic-bezier(0.68,-0.6,0.32,1.6)] origin-center ham-line-3"></span>
             </div>
         </button>
      </div>
    </div>
  </div>

  <!-- Backdrop con blur para el menú móvil -->
  <div 
    id="mobile-menu-backdrop"
    class="fixed inset-0 bg-slate-900/20 dark:bg-black/40 backdrop-blur-sm z-[85] transition-all duration-500 opacity-0 invisible pointer-events-none"
    aria-hidden="true"
  ></div>

  <!-- 4. MOBILE MENU (Mejorado) -->
  <div 
    id="mobile-menu-dropdown" 
    class="fixed top-[80px] inset-x-4 z-[90] origin-top transform transition-all duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] 
           opacity-0 invisible pointer-events-none -translate-y-4 scale-[0.98]"
  >
      <!-- Background ajustado a #0B1120 para consistencia -->
      <div class="bg-white/95 dark:bg-[#0B1120]/95 backdrop-blur-2xl rounded-[2rem] border border-slate-200 dark:border-white/10 shadow-2xl shadow-blue-900/20 dark:shadow-black/50 overflow-hidden ring-1 ring-black/5 max-h-[80vh] overflow-y-auto custom-scrollbar">
          
          <nav class="flex flex-col p-3 space-y-1">
             {navLinks.map((link) => {
                 if (link.children) {
                     return (
                         <div class="mobile-group rounded-2xl overflow-hidden">
                             <button 
                                class="flex items-center justify-between w-full px-5 py-3.5 text-left rounded-2xl hover:bg-slate-100 dark:hover:bg-white/5 transition-all group mobile-accordion-trigger select-none active:scale-[0.98]"
                                aria-expanded="false"
                             >
                                 <span class="font-bold text-slate-900 dark:text-white text-base">{link.label}</span>
                                 <span class="w-8 h-8 rounded-full bg-slate-100 dark:bg-white/10 flex items-center justify-center group-hover:bg-blue-100 dark:group-hover:bg-blue-600/30 transition-colors">
                                     <svg class="w-4 h-4 text-slate-500 dark:text-slate-400 group-hover:text-blue-600 dark:group-hover:text-white transition-transform duration-300 accordion-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                                 </span>
                             </button>
                             
                             <div class="grid grid-rows-[0fr] transition-[grid-template-rows] duration-300 ease-out mobile-accordion-grid">
                                 <div class="overflow-hidden">
                                     <div class="px-3 pt-2 pb-3 space-y-1">
                                         {link.children.map(child => (
                                             <a href={child.href} class="flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-white/5 border border-transparent hover:border-blue-200 dark:hover:border-blue-500/30 text-base font-medium text-slate-700 dark:text-slate-200 hover:text-blue-700 dark:hover:text-blue-300 transition-all active:scale-[0.98]">
                                                 <!-- Mini icon mobile -->
                                                 <span class="w-1.5 h-1.5 rounded-full bg-blue-400 shrink-0"></span>
                                                 <span class="flex-1">{child.label}</span>
                                                 <span class="text-[10px] uppercase tracking-widest text-slate-400 font-bold">Ir →</span>
                                             </a>
                                         ))}
                                     </div>
                                 </div>
                             </div>
                         </div>
                     )
                 }
                 
                 const active = isActive(link.href);
                 return (
                     <a href={link.href} class={`flex items-center w-full px-5 py-4 rounded-2xl text-lg font-bold transition-all active:scale-[0.98] ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-600/30' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white'}`}>
                         {link.label}
                     </a>
                 );
             })}
          </nav>

          <div class="p-4 mt-2 border-t border-slate-100 dark:border-white/5 bg-slate-50 dark:bg-[#0f1520] flex flex-col gap-4">
               <div class="flex items-center justify-between px-2 py-1">
                   <span class="text-sm font-semibold text-slate-500 dark:text-slate-400">Apariencia</span>
                   <DarkModeToggle />
               </div>
               <a href="https://www.mitelcel.com/mitelcel/login" target="_blank" class="w-full flex items-center justify-center py-3.5 rounded-xl bg-slate-900 dark:bg-blue-600 text-white font-bold shadow-lg shadow-slate-900/10 active:scale-95 transition-transform hover:bg-slate-800 dark:hover:bg-blue-500">
                   Acceso a Mi Telcel
               </a>
          </div>
      </div>
  </div>
</header>

<style>
  /* Animación Hamburguesa */
  .menu-active .ham-line-1 { transform: translateY(6px) rotate(45deg); }
  .menu-active .ham-line-2 { opacity: 0; transform: scaleX(0); }
  .menu-active .ham-line-3 { transform: translateY(-6px) rotate(-45deg); }
  
  #mobile-menu-btn.menu-active {
      @apply bg-slate-900 dark:bg-white border-slate-900 dark:border-white;
  }
  #mobile-menu-btn.menu-active span {
      @apply bg-white dark:bg-slate-900;
  }

  .mobile-accordion-trigger[aria-expanded="true"] .accordion-icon {
      transform: rotate(180deg);
  }
  .mobile-accordion-trigger[aria-expanded="true"] {
      @apply text-blue-600 dark:text-blue-400;
  }
  .mobile-accordion-grid.open {
      grid-template-rows: 1fr;
  }
  
  /* SCROLL EFFECT: IMPORTANTE
     Usamos #0B1120 en dark mode para que coincida con el fondo del site */
  .header-scrolled #header-bg {
     @apply bg-white/60 dark:bg-[#0B1120]/60 backdrop-blur-xl border-slate-200/50 dark:border-white/10 shadow-sm;
  }

  .dropdown-active {
      opacity: 1 !important;
      visibility: visible !important;
      pointer-events: auto !important;
      transform: translateY(0) scale(100%) !important;
  }

  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
  .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #334155; }
</style>

<script>
    const setupHeader = () => {
        const header = document.getElementById("main-header");
        const btn = document.getElementById("mobile-menu-btn");
        const dropdown = document.getElementById("mobile-menu-dropdown");
        const backdrop = document.getElementById("mobile-menu-backdrop");
        
        if (header) {
            // Limpieza de listeners previos
            const oldHandler = (window as any).__headerScrollHandler;
            if (oldHandler) window.removeEventListener("scroll", oldHandler);
            
            const handleScroll = () => {
                if (window.scrollY > 10) header.classList.add("header-scrolled");
                else header.classList.remove("header-scrolled");
            };
            
            (window as any).__headerScrollHandler = handleScroll;
            window.addEventListener("scroll", handleScroll, { passive: true });
            handleScroll();
        }

        let isOpen = false;
        
        const closeMenu = () => {
            isOpen = false;
            btn?.classList.remove("menu-active");
            btn?.setAttribute("aria-expanded", "false");
            dropdown?.classList.remove("dropdown-active");
            backdrop?.classList.remove("!opacity-100", "!visible", "!pointer-events-auto");
            document.body.style.overflow = '';
        };

        const toggleMenu = () => {
            isOpen = !isOpen;
            if (isOpen) {
                btn?.classList.add("menu-active");
                btn?.setAttribute("aria-expanded", "true");
                dropdown?.classList.add("dropdown-active");
                backdrop?.classList.add("!opacity-100", "!visible", "!pointer-events-auto");
                document.body.style.overflow = 'hidden';
            } else {
                closeMenu();
            }
        };

        const newBtn = btn?.cloneNode(true);
        if (btn && newBtn && btn.parentNode) {
            btn.parentNode.replaceChild(newBtn, btn);
            (newBtn as HTMLElement).addEventListener("click", (e) => {
                e.stopPropagation();
                toggleMenu();
            });
        }

        // Cerrar menú al hacer clic en el backdrop
        backdrop?.addEventListener('click', closeMenu);

        // Cerrar si click fuera
        document.addEventListener('click', (e) => {
             if (isOpen && dropdown && !dropdown.contains(e.target as Node) && !newBtn?.contains(e.target as Node)) {
                closeMenu();
             }
        });

        const triggers = document.querySelectorAll(".mobile-accordion-trigger");
        triggers.forEach(trigger => {
            const newTrigger = trigger.cloneNode(true);
            trigger.parentNode?.replaceChild(newTrigger, trigger);
            newTrigger.addEventListener("click", function(this: HTMLElement) {
                const isExpanded = this.getAttribute("aria-expanded") === "true";
                this.setAttribute("aria-expanded", String(!isExpanded));
                const grid = this.nextElementSibling;
                if (grid) grid.classList.toggle("open");
            });
        });
        
        dropdown?.querySelectorAll("a").forEach(link => {
            link.addEventListener("click", closeMenu);
        });
    };

    document.addEventListener("astro:page-load", setupHeader);
    document.addEventListener("DOMContentLoaded", setupHeader);
</script>