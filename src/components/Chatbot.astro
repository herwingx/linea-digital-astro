---
// src/components/Chatbot.astro
/**
 * Componente de Chatbot con IA
 *
 * Widget flotante que permite a los usuarios interactuar
 * con el asistente virtual de L√≠nea Digital.
 *
 * Ahora usando Tailwind CSS para mejor mantenibilidad
 */
---

<div id="chatbot-container" class="fixed z-[9999]">
  <!-- Bot√≥n flotante (FAB) -->
  <button
    id="chatbot-toggle"
    class="fixed bottom-6 right-6 w-[60px] h-[60px] rounded-full bg-gradient-to-br from-blue-600 to-blue-800 border-0 shadow-lg shadow-blue-500/40 cursor-pointer flex items-center justify-center transition-all duration-300 ease-out z-[10000] hover:scale-110 hover:shadow-xl hover:shadow-blue-500/50 active:scale-95"
    aria-label="Abrir chat de asistencia"
    type="button"
  >
    <!-- Icono de chat -->
    <svg
      class="chatbot-icon-chat w-7 h-7 text-white transition-all duration-300"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
      ></path>
    </svg>

    <!-- Icono de cerrar -->
    <svg
      class="chatbot-icon-close hidden w-7 h-7 text-white transition-all duration-300"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M6 18L18 6M6 6l12 12"></path>
    </svg>

    <!-- Badge de notificaci√≥n -->
    <span
      class="chatbot-badge absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center border-2 border-white animate-pulse"
      id="chatbot-badge"
    >
      1
    </span>
  </button>

  <!-- Ventana de chat -->
  <div
    id="chatbot-window"
    class="chatbot-window fixed bottom-24 right-6 w-[400px] max-w-[calc(100vw-48px)] h-[600px] max-h-[calc(100vh-140px)] bg-white dark:bg-slate-900 rounded-3xl shadow-2xl shadow-slate-900/10 dark:shadow-black/50 hidden flex-col opacity-0 translate-y-5 scale-95 pointer-events-none transition-all duration-300 ease-out z-[9999] overflow-hidden"
  >
    <!-- Header -->
    <div
      class="bg-gradient-to-br from-blue-600 to-blue-800 text-white px-5 py-4 flex justify-between items-center flex-shrink-0"
    >
      <div class="flex gap-3 items-center">
        <div
          class="w-11 h-11 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0"
        >
          <svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6">
            <path
              d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"
            ></path>
            <circle cx="12" cy="10" r="1.5"></circle>
            <circle cx="8" cy="10" r="1.5"></circle>
            <circle cx="16" cy="10" r="1.5"></circle>
          </svg>
        </div>
        <div class="flex-1">
          <h3 class="text-base font-bold m-0 leading-tight">
            Asistente Virtual
          </h3>
          <p class="text-xs mt-1 flex items-center gap-1.5 opacity-90 m-0">
            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"
            ></span>
            En l√≠nea
          </p>
        </div>
      </div>
      <button
        id="chatbot-minimize"
        class="bg-white/20 border-0 w-9 h-9 rounded-lg cursor-pointer flex items-center justify-center transition-colors duration-200 flex-shrink-0 hover:bg-white/30"
        aria-label="Minimizar chat"
        type="button"
      >
        <svg
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          class="w-5 h-5 text-white"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
    </div>

    <!-- √Årea de mensajes -->
    <div
      id="chatbot-messages"
      class="flex-1 overflow-y-auto p-5 bg-slate-100 dark:bg-slate-950 flex flex-col gap-0 scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-700 scrollbar-track-transparent"
    >
      <!-- Mensaje de bienvenida -->
      <div
        class="chatbot-message chatbot-message-bot flex flex-col max-w-[75%] self-start mb-2 animate-slide-up"
      >
        <div
          class="px-4 py-3 rounded-2xl text-sm leading-relaxed break-words bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 shadow-sm border border-slate-200 dark:border-slate-700"
        >
          ¬°Hola! üëã Soy tu asistente virtual de L√≠nea Digital.<br /><br />
          ¬øEn qu√© puedo ayudarte hoy?
        </div>
        <span class="text-[11px] text-slate-500 dark:text-slate-400 mt-1 px-2"
          >Ahora</span
        >
      </div>
    </div>

    <!-- Respuestas r√°pidas -->
    <div
      id="chatbot-quick-replies"
      class="px-5 py-3 flex gap-2 overflow-x-auto bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 flex-shrink-0 scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-700"
    >
      <button
        class="chatbot-quick-reply px-4 py-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full text-xs whitespace-nowrap cursor-pointer transition-all duration-200 text-slate-700 dark:text-slate-300 hover:bg-blue-50 dark:hover:bg-blue-900/30 hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400"
        data-message="¬øCu√°les son sus planes m√≥viles?"
        type="button"
      >
        üì± Ver planes
      </button>
      <button
        class="chatbot-quick-reply px-4 py-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full text-xs whitespace-nowrap cursor-pointer transition-all duration-200 text-slate-700 dark:text-slate-300 hover:bg-blue-50 dark:hover:bg-blue-900/30 hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400"
        data-message="¬øD√≥nde est√°n ubicados?"
        type="button"
      >
        üìç Ubicaci√≥n
      </button>
      <button
        class="chatbot-quick-reply px-4 py-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full text-xs whitespace-nowrap cursor-pointer transition-all duration-200 text-slate-700 dark:text-slate-300 hover:bg-blue-50 dark:hover:bg-blue-900/30 hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400"
        data-message="¬øCu√°l es su horario de atenci√≥n?"
        type="button"
      >
        üïê Horario
      </button>
    </div>

    <!-- Input de mensaje -->
    <form
      id="chatbot-form"
      class="px-5 py-4 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 flex gap-3 flex-shrink-0 relative z-10"
    >
      <input
        type="text"
        id="chatbot-input"
        class="flex-1 px-4 py-3 border border-slate-200 dark:border-slate-700 rounded-full text-sm outline-none transition-colors duration-200 bg-white dark:bg-slate-800 text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-blue-500 dark:focus:border-blue-400"
        placeholder="Escribe tu mensaje..."
        autocomplete="off"
        maxlength="500"
        aria-label="Mensaje del chat"
      />
      <button
        type="submit"
        class="w-11 h-11 bg-blue-600 border-0 rounded-full cursor-pointer flex items-center justify-center transition-all duration-200 flex-shrink-0 hover:bg-blue-700 hover:scale-105 active:scale-95 disabled:bg-slate-300 dark:disabled:bg-slate-700 disabled:cursor-not-allowed disabled:opacity-50"
        aria-label="Enviar mensaje"
        id="chatbot-send-btn"
      >
        <svg
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          class="w-5 h-5 text-white"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
      </button>
    </form>
  </div>
</div>

<style>
  /* === ANIMACIONES PERSONALIZADAS === */
  @keyframes slide-up {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-slide-up {
    animation: slide-up 0.3s ease-out;
  }

  /* === ESTADOS DEL BOT√ìN FAB === */
  #chatbot-toggle.active .chatbot-icon-chat {
    display: none;
  }

  #chatbot-toggle.active .chatbot-icon-close {
    display: block;
  }

  .chatbot-badge.hidden {
    display: none;
  }

  /* === ESTADO ACTIVO DE LA VENTANA === */
  .chatbot-window.active {
    display: flex;
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: all;
  }

  /* === ESTILOS DE MENSAJES === */
  .chatbot-message {
    animation: slide-up 0.3s ease-out;
  }

  .chatbot-message-bot {
    align-self: flex-start;
  }

  .chatbot-message-user {
    align-self: flex-end;
  }

  .chatbot-message-user .chatbot-message-content {
    @apply bg-blue-600 text-white shadow-md shadow-blue-600/30;
  }

  /* === ANIMACI√ìN PARA TYPING INDICATOR (GLOBAL) === */
</style>

<style is:global>
  @keyframes typing {
    0%,
    60%,
    100% {
      transform: translateY(0);
      opacity: 0.4;
    }
    30% {
      transform: translateY(-12px);
      opacity: 1;
    }
  }
</style>

<style>
  /* === MARKDOWN EN MENSAJES === */
  .chatbot-message-content p {
    @apply m-0 p-0;
  }

  .chatbot-message-content p + p {
    @apply mt-2;
  }

  .chatbot-message-content strong {
    @apply font-bold;
  }

  .chatbot-message-content em {
    @apply italic;
  }

  .chatbot-message-content .chatbot-list {
    @apply my-2 pl-5 list-none;
  }

  .chatbot-message-content .chatbot-list li {
    @apply relative my-1 pl-2;
  }

  .chatbot-message-content .chatbot-list li::before {
    content: "‚Ä¢";
    @apply absolute -left-3 font-bold;
  }

  /* === RESPONSIVE MOBILE === */
  @media (max-width: 640px) {
    .chatbot-window {
      @apply bottom-0 right-0 left-0 w-full max-w-full rounded-none;
      height: 100vh;
      height: 100dvh;
      max-height: 100dvh;
      z-index: 10001;
      position: fixed;
    }

    .chatbot-window.active {
      display: flex;
    }

    #chatbot-toggle {
      @apply bottom-5 right-5;
      width: 56px;
      height: 56px;
    }

    #chatbot-toggle.active {
      display: none;
    }

    .chatbot-icon-chat,
    .chatbot-icon-close {
      @apply w-6 h-6;
    }

    #chatbot-messages {
      @apply px-4 gap-3 flex-1 min-h-0 overflow-y-auto;
      -webkit-overflow-scrolling: touch;
    }

    .chatbot-message {
      @apply max-w-[90%];
    }

    .chatbot-message-content {
      @apply px-3.5 py-2.5 text-sm;
    }

    .chatbot-window > div:first-child {
      @apply px-4 flex-shrink-0;
    }

    .chatbot-window > div:first-child > div > div:first-child {
      @apply w-10 h-10;
    }

    .chatbot-window > div:first-child > div > div:first-child svg {
      @apply w-5 h-5;
    }

    .chatbot-window > div:first-child > div > div:last-child h3 {
      @apply text-[15px];
    }

    .chatbot-window > div:first-child > div > div:last-child p {
      @apply text-[11px];
    }

    /* INPUT: Sticky para que siempre sea visible */
    #chatbot-form {
      @apply px-4 py-3 sticky bottom-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 flex-shrink-0 z-[100];
      padding-bottom: max(12px, env(safe-area-inset-bottom));
    }

    #chatbot-input {
      @apply px-3.5 py-2.5 text-base;
    }

    /* Quick replies tambi√©n sticky */
    #chatbot-quick-replies {
      @apply px-4 py-2.5 sticky bottom-0 flex-shrink-0 z-[99];
      padding-bottom: max(10px, env(safe-area-inset-bottom));
    }

    .chatbot-quick-reply {
      @apply px-3 py-1.5 text-xs;
    }

    /* Ajuste adicional para cuando el teclado est√° abierto */
    .chatbot-window.keyboard-open #chatbot-messages {
      @apply pb-4;
    }
  }

  /* === ACCESIBILIDAD === */
  @media (prefers-reduced-motion: reduce) {
    #chatbot-toggle,
    .chatbot-window,
    .chatbot-message,
    * {
      animation: none !important;
      transition: none !important;
    }
  }
</style>

<script>
  import { ChatbotClient } from "../lib/chatbot-client";

  // El cliente se inicializa autom√°ticamente
</script>
