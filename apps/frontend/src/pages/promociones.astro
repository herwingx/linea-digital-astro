---
// src/pages/promociones.astro
import BaseLayout from "../layouts/BaseLayout.astro";

// === TYPES ===
interface PromoField {
  titulo: string;
  descripcion: string;
  imagen: { fields: { file: { url: string } } };
  fechaFin: string | null;
  tipo: string;
  destacado: boolean;
}

interface ContentfulItem {
  sys: { id: string };
  fields: PromoField;
}

// === DATA MOCK REFINADO (Imágenes HD oscuras) ===
const responseContentful: ContentfulItem[] = [
  // ... (Mantén tus Hero Items iguales si ya te gustaban)
  
  // GRID ITEMS
  {
    sys: { id: "grid-1" },
    fields: {
      titulo: "Fibra Simétrica 1GB", // Cambié nombre a algo más corto para mobile
      descripcion: "La conexión que tu empresa merece. IP fija disponible.",
      // Imagen: Abstracta/Futurista (Network)
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop" } } },
      fechaFin: null,
      tipo: "Empresas",
      destacado: false, 
    },
  },
  {
    sys: { id: "grid-2" },
    fields: {
      titulo: "Galaxy S24 Ultra",
      descripcion: "Titanium Frame. El Android definitivo con IA integrada.",
      // Imagen: Smartphone Dark Mode
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1610945265064-0e34e5519bbf?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" } } },
      fechaFin: new Date(Date.now() + 24 * 3600 * 1000).toISOString(),
      tipo: "Smartphone",
      destacado: true,
    },
  },
  {
    sys: { id: "grid-3" },
    fields: {
      titulo: "Apple Watch Ultra 2",
      descripcion: "El reloj deportivo definitivo. Caja de titanio de 49mm.",
      // Imagen: Reloj Close up
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1614106765035-bceac4ac1911?q=80&w=687&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" } } },
      fechaFin: null,
      tipo: "Wearable",
      destacado: false,
    },
  },
  {
    sys: { id: "grid-4" },
    fields: {
      titulo: "Sony WH-1000XM5",
      descripcion: "Sumérgete en tu música. Noise Cancelling líder mundial.",
      // Imagen: Audífonos Studio
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1618366712010-f4ae9c647dcb?q=80&w=1888&auto=format&fit=crop" } } },
      fechaFin: new Date(Date.now() + 10 * 3600 * 1000).toISOString(),
      tipo: "Audio Premium",
      destacado: false,
    },
  },
  {
    sys: { id: "grid-5" },
    fields: {
      titulo: "iPad Pro M4",
      descripcion: "Tu próxima computadora no es una computadora.",
      // Imagen: Tablet en mesa oscura
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1544244015-0df4b3ffc6b0?q=80&w=2030&auto=format&fit=crop" } } },
      fechaFin: new Date(Date.now() + 48 * 3600 * 1000).toISOString(),
      tipo: "Productividad",
      destacado: true,
    },
  },
  {
    sys: { id: "grid-6" },
    fields: {
      titulo: "iPhone 15 Pro Max",
      descripcion: "Titanio aeroespacial. Chip A17 Pro. Llévatelo hoy con 0% de interés y doble de gigas por 12 meses.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1695048133142-1a20484d2569?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: new Date(Date.now() + 48 * 3600 * 1000).toISOString(),
      tipo: "Oferta Flash",
      destacado: true,
    },
  },
  {
    sys: { id: "grid-7" },
    fields: {
      titulo: "PlayStation 5 Slim",
      descripcion: "El regalo perfecto existe. Incluye FC 24 + 2 Controles. Pocas unidades disponibles.",
      imagen: { fields: { file: { url: "https://images.unsplash.com/photo-1606144042614-b2417e99c4e3?q=80&w=2070&auto=format&fit=crop" } } },
      fechaFin: new Date(Date.now() + 72 * 3600 * 1000).toISOString(),
      tipo: "Bundle Exclusivo",
      destacado: false,
    },
  },
];

const heroPromos = responseContentful.filter((p) => p.fields.destacado);
const gridPromos = responseContentful.filter((p) => !p.fields.destacado);

const WA_NUMBER = "529614603593";
---

<BaseLayout
  title="Ofertas Exclusivas | Línea Digital"
  description="Tecnología de punta y planes exclusivos disponibles por tiempo limitado. Aprovecha nuestras promociones hoy."
>
  
<!-- === HERO SECTION: CINEMATIC RETAIL === -->
  {heroPromos.length > 0 && (
    <section class="relative w-full h-[calc(100vh-5rem)] min-h-[700px] bg-[#020617] overflow-hidden group">
        
      <!-- Fondo Atmosférico (Global) -->
      <div class="absolute -top-20 -left-20 w-[800px] h-[800px] bg-blue-600/10 rounded-full blur-[120px] pointer-events-none mix-blend-screen z-0 animate-pulse-slow"></div>

      <!-- SWIPER CONTAINER -->
      <div class="swiper hero-swiper w-full h-full relative z-10">
        <div class="swiper-wrapper">
          {heroPromos.map((promo, index) => (
            <div class="swiper-slide relative w-full h-full flex items-center">
                
                <!-- 1. Imagen de Fondo (Optimizada para NO chocar con el texto) -->
                <div class="absolute inset-0 z-0">
                     <img
                        src={promo.fields.imagen.fields.file.url}
                        alt={promo.fields.titulo}
                        
                        class="w-full h-full object-cover object-[70%_center] md:object-right transition-transform duration-[20000ms] ease-linear scale-100 group-hover:scale-110" 
                        loading={index === 0 ? "eager" : "lazy"}
                    />
                    
                    <!-- MÁSCARAS INTELIGENTES -->
                    <!-- A. Oscurece TOTALMENTE la izquierda (escritorio) para contraste de texto perfecto -->
                    <div class="absolute inset-0 bg-gradient-to-r from-[#101623] via-[#101623]/80 to-transparent md:via-[#101623]/40"></div>
                    
                    <!-- B. Oscurece abajo (móvil) -->
                    <div class="absolute inset-0 bg-gradient-to-t from-[#101623] via-[#101623]/60 to-transparent md:hidden"></div>
                </div>

                <!-- 2. Contenido "Flotante" -->
                <div class="relative z-10 container mx-auto px-6 md:px-12 h-full flex flex-col justify-end pb-24 md:justify-center md:pb-0">
                    <div class="max-w-3xl relative">
                        
                        <!-- Decorative Badge (Capsule) -->
                        <div class="opacity-0 translate-y-8 slide-content-entry mb-6">
                             <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-500/10 border border-blue-500/20 backdrop-blur-md shadow-[0_0_20px_rgba(59,130,246,0.2)]">
                                <span class="relative flex h-2.5 w-2.5">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-blue-500 shadow-[0_0_10px_#3b82f6]"></span>
                                </span>
                                <span class="text-xs font-black uppercase tracking-[0.15em] text-white text-shadow-sm">{promo.fields.tipo}</span>
                             </div>
                        </div>

                        <!-- Título Masivo (Outline visual + Fill) -->
                        <div class="relative opacity-0 translate-y-8 transition-all duration-700 delay-100 slide-content-entry">
                             <!-- Texto Sombra/Efecto detrás (Opcional para profundidad) -->
                             <h1 class="absolute -top-1 -left-1 text-5xl md:text-7xl lg:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-br from-blue-600/20 to-transparent select-none blur-sm pointer-events-none tracking-tighter leading-[0.9]">
                                {promo.fields.titulo}
                             </h1>
                             
                             <!-- Texto Principal -->
                             <h1 class="relative text-5xl md:text-7xl lg:text-8xl font-black text-white tracking-tighter leading-[0.95] drop-shadow-2xl">
                                {promo.fields.titulo}
                             </h1>
                        </div>
                        
                        <!-- Descripción con Borde Gradiente -->
                        <div class="mt-6 pl-6 border-l-4 border-transparent border-image-slice-1 opacity-0 translate-y-8 transition-all duration-700 delay-200 slide-content-entry" 
                             style="border-image-source: linear-gradient(to bottom, #3b82f6, transparent);">
                            <p class="text-lg md:text-2xl text-slate-200 font-medium leading-relaxed max-w-2xl text-shadow-sm">
                                {promo.fields.descripcion}
                            </p>
                        </div>

                        <!-- ACTIONS AREA -->
                        <div class="mt-10 flex flex-col sm:flex-row items-start sm:items-center gap-6 opacity-0 translate-y-8 transition-all duration-700 delay-300 slide-content-entry">
                            
                            <!-- Botón Primario "Luminoso" -->
                            <a
                                href={`https://wa.me/${WA_NUMBER}?text=¡Hola! Quiero cotizar: ${promo.fields.titulo}`}
                                target="_blank"
                                class="group/btn relative inline-flex items-center justify-center gap-3 px-10 py-5 overflow-hidden rounded-2xl bg-white text-slate-900 shadow-[0_0_40px_-10px_rgba(255,255,255,0.3)] transition-all duration-300 hover:scale-105 hover:shadow-[0_0_60px_-10px_rgba(255,255,255,0.5)] active:scale-95"
                            >
                                <span class="relative z-10 font-black uppercase tracking-widest text-sm">Cotizar Ahora</span>
                                <svg class="relative z-10 w-5 h-5 transition-transform duration-300 group-hover/btn:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
                                
                                <!-- Shine Interno -->
                                <div class="absolute inset-0 -translate-x-full group-hover/btn:animate-[shine_1s_ease-in-out_infinite] bg-gradient-to-r from-transparent via-slate-100 to-transparent z-0"></div>
                            </a>

                            <!-- Timer de Alta Tecnología -->
                            {promo.fields.fechaFin && (
                                <div class="group/timer relative px-5 py-2.5 rounded-xl bg-black/30 border border-white/10 backdrop-blur-md flex items-center gap-4 select-none transition-all hover:bg-black/50 hover:border-red-500/30" data-timer-target={promo.fields.fechaFin}>
                                    <div>
                                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Termina en</p>
                                        <div class="font-mono text-xl font-bold text-white flex items-baseline gap-1 tabular-nums tracking-tight shadow-red-glow">
                                            <span class="timer-d">00</span><span class="text-xs text-slate-500 font-sans">d</span> :
                                            <span class="timer-h">00</span><span class="text-xs text-slate-500 font-sans">h</span> :
                                            <span class="timer-m text-red-400">00</span><span class="text-xs text-red-900/80 font-sans">m</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
          ))}
        </div>

        <!-- Pagination Moderna -->
        <div class="absolute bottom-8 right-8 z-20 hidden md:flex gap-4">
            <!-- Flechas Custom o Bullets -->
            <div class="swiper-pagination-custom-container bg-black/20 backdrop-blur-lg border border-white/10 px-4 py-2 rounded-full flex items-center gap-3 hover:bg-black/40 transition-colors"></div>
        </div>
      </div>
    </section>
  )}

<!-- === GRID SECTION: CATÁLOGO BENTO === -->
  <section class="md:py-24 py-8 bg-slate-50 dark:bg-[#101623] relative transition-colors duration-500 mask-gradient-bottom">
    
    <!-- Divider visual superior -->
    <div class="absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-slate-200 dark:via-slate-800 to-transparent opacity-50"></div>

    <div class="container mx-auto px-6 mb-16">
        
        <!-- Header Alineado a la izquierda -->
        <div class="mb-12 flex flex-col md:flex-row items-end justify-between gap-6 border-b border-slate-200 dark:border-white/5 pb-6">
            <div>
                <span class="text-blue-600 dark:text-blue-500 font-bold uppercase tracking-widest text-xs mb-2 block pl-1">Disponibilidad Inmediata</span>
                <h2 class="text-4xl md:text-5xl font-black text-slate-900 dark:text-white tracking-tighter">
                    Catálogo <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-blue-400 dark:from-blue-400 dark:to-white">Destacado.</span>
                </h2>
            </div>
            
            <a href="/catalogo" class="group flex items-center gap-2 text-sm font-bold text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-white transition-colors px-4 py-2 rounded-full hover:bg-slate-100 dark:hover:bg-white/5 border border-transparent hover:border-slate-200 dark:hover:border-white/10">
                Ver todo el inventario
                <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
            </a>
        </div>

        <!-- BENTO GRID RESPONSIVE -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-[380px] md:auto-rows-[450px]">
            
            {gridPromos.map((promo, index) => {
                // Patrón: 1er elemento de cada fila de 3 ocupa 2 columnas
                const isWide = index % 3 === 0;
                
                return (
                    <article 
                        class={`
                            group relative overflow-hidden rounded-[2.5rem] 
                            bg-white dark:bg-[#0f172a] border border-slate-200 dark:border-white/5 hover:border-blue-500/30 dark:hover:border-white/20
                            shadow-xl shadow-slate-200/50 dark:shadow-black/40 hover:shadow-2xl hover:shadow-blue-500/10 dark:hover:shadow-blue-900/20
                            transition-all duration-500 ease-out hover:-translate-y-1
                            ${isWide ? "md:col-span-2" : "md:col-span-1"}
                        `}
                    >
                        <!-- Full Click Overlay -->
                        <a 
                            href={`https://wa.me/${WA_NUMBER}?text=Me interesa cotizar: ${promo.fields.titulo}`}
                            target="_blank" 
                            class="absolute inset-0 z-30 cursor-pointer"
                            aria-label={`Ver detalles de ${promo.fields.titulo}`}
                        ></a>

                        <!-- 1. Imagen con Zoom Effect -->
                        <div class="absolute inset-0 z-0 w-full h-full bg-slate-100 dark:bg-slate-900">
                            <img
                                src={promo.fields.imagen.fields.file.url}
                                alt={promo.fields.titulo}
                                class="h-full w-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-90 dark:opacity-80 group-hover:opacity-80 dark:group-hover:opacity-60"
                                loading="lazy"
                            />
                            
                            <!-- Capas de Degradado (Crucial para legibilidad) -->
                            <!-- Gradiente inferior fuerte para el texto -->
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent dark:from-[#020617] dark:via-transparent dark:to-transparent opacity-90"></div>
                            <!-- Gradiente superior sutil -->
                            <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-transparent opacity-40"></div>
                        </div>

                        <!-- 2. Contenido Informativo -->
                        <div class="relative z-10 h-full flex flex-col justify-between p-8 select-none pointer-events-none">
                            
                            <!-- Top: Badge -->
                            <div class="flex items-start justify-between">
                                <span class="inline-flex items-center px-3 py-1 rounded-lg bg-white/20 backdrop-blur-md border border-white/20 text-[10px] font-black uppercase tracking-widest text-white shadow-sm group-hover:bg-blue-600 group-hover:border-blue-500 transition-colors duration-300">
                                    {promo.fields.tipo}
                                </span>
                                
                                <!-- Icono Flecha Top Right (Visual cue) -->
                                <div class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center opacity-0 group-hover:opacity-100 -translate-y-2 group-hover:translate-y-0 transition-all duration-500 border border-white/20">
                                    <svg class="w-5 h-5 text-white transform -rotate-45 group-hover:rotate-0 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                                </div>
                            </div>

                            <!-- Bottom: Info -->
                            <div class="transform translate-y-2 group-hover:translate-y-0 transition-transform duration-500">
                                
                                <!-- Título -->
                                <h3 class={`text-white font-black leading-[0.95] mb-2 drop-shadow-lg ${isWide ? 'text-4xl md:text-5xl' : 'text-3xl'}`}>
                                    {promo.fields.titulo}
                                </h3>
                                
                                <!-- Reveal Container (Height animation) -->
                                <div class="grid grid-rows-[0fr] group-hover:grid-rows-[1fr] transition-[grid-template-rows] duration-500 ease-out">
                                     <div class="overflow-hidden">
                                         <p class="text-slate-200 text-sm font-medium leading-relaxed pt-2 border-l-2 border-blue-500 pl-3 mb-4 opacity-0 group-hover:opacity-100 transition-opacity delay-100 duration-500">
                                            {promo.fields.descripcion}
                                         </p>
                                         
                                         <!-- Call to Action Link Visual -->
                                         <span class="inline-flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-blue-300 group-hover:text-white transition-colors">
                                            Solicitar Cotización 
                                            <span class="w-4 h-px bg-current"></span>
                                         </span>
                                     </div>
                                </div>

                            </div>
                        </div>
                    </article>
                );
            })}
        </div>

    </div>
  </section>
</BaseLayout>

<script>
  import Swiper from "swiper";
  import { Autoplay, EffectCreative, Pagination } from "swiper/modules";
  import "swiper/css";
  
  // Script Optimizado
  const init = () => {
    // 1. Swiper
    const swiperEl = document.querySelector(".hero-swiper") as HTMLElement & { swiper?: any };
    
    if (swiperEl && !swiperEl.swiper) {
      new Swiper(swiperEl, {
        modules: [Autoplay, EffectCreative, Pagination],
        effect: "creative",
        creativeEffect: {
          prev: { shadow: true, translate: ["-20%", 0, -1], opacity: 0 },
          next: { translate: ["100%", 0, 0] },
        },
        speed: 1000,
        loop: true,
        autoplay: { delay: 5000, disableOnInteraction: false },
        pagination: { 
            el: ".swiper-pagination-custom-container", 
            clickable: true,
            renderBullet: (_index, className) => {
                return `<button class="${className} w-2 h-2 rounded-full bg-white/50 hover:bg-white transition-all duration-300 mx-1" aria-label="Go to slide"></button>`;
            }
        },
      });
    }

    // 2. Countdown Timer
    const updateTimers = () => {
      const now = Date.now();
      document.querySelectorAll("[data-timer-target]").forEach((el) => {
        const targetStr = el.getAttribute("data-timer-target");
        if(!targetStr) return;
        const end = new Date(targetStr).getTime();
        const diff = end - now;

        if (diff <= 0) return; // Expired

        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        const setVal = (sel: string, v: number) => {
             const node = el.querySelector(sel);
             if(node) node.textContent = v.toString().padStart(2, '0');
        };
        setVal('.timer-d', d); setVal('.timer-h', h); setVal('.timer-m', m);
      });
    };
    
    updateTimers(); 
    const interval = setInterval(updateTimers, 60000); // Actualizar cada minuto es suficiente para D/H/M
    
    // Clean interval on navigation
    document.addEventListener("astro:before-swap", () => clearInterval(interval), { once: true });
  };

  document.addEventListener("astro:page-load", init);
  document.addEventListener("DOMContentLoaded", init);
</script>

<style is:global>
   /* Máscara de desvanecimiento solo en bottom */
   .mask-gradient-bottom {
     -webkit-mask-image: 
       linear-gradient(to bottom, black 0%, black 90%, transparent 100%);
     -webkit-mask-size: 100% 100%;
     mask-image: 
       linear-gradient(to bottom, black 0%, black 90%, transparent 100%);
     mask-size: 100% 100%;
   }
  /* --- CUSTOM SWIPER PAGINATION --- */
  .swiper-pagination-bullet {
    width: 6px !important;
    height: 6px !important;
    margin: 0 4px !important;
    background: rgba(255, 255, 255, 0.4) !important;
    opacity: 1 !important;
    transition: all 0.3s ease;
  }

  .swiper-pagination-bullet-active {
    background: #fff !important;
    transform: scale(1.5);
    box-shadow: 0 0 10px rgba(255,255,255,0.8);
  }

  /* --- TEXT ANIMATIONS --- */
  .swiper-slide-active .slide-content-entry {
    opacity: 1 !important;
    transform: translateY(0) !important;
  }

  .slide-content-entry {
    transition-timing-function: cubic-bezier(0.16, 1, 0.3, 1); /* Ease Out Expo */
  }
  
  @keyframes shine {
      100% { left: 125%; }
  }
</style>