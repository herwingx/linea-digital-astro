---
// Generamos un ID único para cada instancia del componente
const id = `dark-toggle-${Math.random().toString(36).substring(2, 9)}`;
---

<div class="flex items-center justify-center">
  <label
    for={id}
    class="flex h-9 w-16 cursor-pointer items-center justify-between rounded-full bg-slate-100 p-1 dark:bg-slate-800 transition-colors duration-200 border border-slate-200 dark:border-slate-700 shadow-inner hover:border-blue-200 dark:hover:border-slate-600"
  >
    <input
      type="checkbox"
      id={id}
      class="peer sr-only theme-toggle-input"
      aria-label="Alternar modo oscuro"
    />

    <!-- Icono Sol (Izquierda - Activo en Light) -->
    <span
      class="flex items-center justify-center w-7 h-7 rounded-full bg-blue-600 text-white transition-all duration-200 shadow-sm peer-checked:bg-transparent peer-checked:text-slate-400 peer-checked:shadow-none"
    >
      <svg width="14" height="14" viewBox="0 0 16 16" class="fill-current">
        <path
          d="M4.50663 3.2267L3.30663 2.03337L2.36663 2.97337L3.55996 4.1667L4.50663 3.2267ZM2.66663 7.00003H0.666626V8.33337H2.66663V7.00003ZM8.66663 0.366699H7.33329V2.33337H8.66663V0.366699ZM13.6333 2.97337L12.6933 2.03337L11.5 3.2267L12.44 4.1667L13.6333 2.97337ZM11.4933 12.1067L12.6866 13.3067L13.6266 12.3667L12.4266 11.1734L11.4933 12.1067ZM13.3333 7.00003V8.33337H15.3333V7.00003H13.3333ZM7.99996 3.6667C5.79329 3.6667 3.99996 5.46003 3.99996 7.6667C3.99996 9.87337 5.79329 11.6667 7.99996 11.6667C10.2066 11.6667 12 9.87337 12 7.6667C12 5.46003 10.2066 3.6667 7.99996 3.6667ZM7.33329 14.9667H8.66663V13H7.33329V14.9667ZM2.36663 12.36L3.30663 13.3L4.49996 12.1L3.55996 11.16L2.36663 12.36Z"
        ></path>
      </svg>
    </span>

    <!-- Icono Luna (Derecha - Activo en Dark) -->
    <span
      class="flex items-center justify-center w-7 h-7 rounded-full bg-transparent text-slate-400 transition-all duration-200 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:shadow-sm"
    >
      <svg width="12" height="12" viewBox="0 0 13 15" class="fill-current">
        <path
          d="M10.6111 12.855C11.591 12.1394 12.3151 11.1979 12.7723 10.1623C10.4824 10.4065 8.1342 9.46314 6.67948 7.47109C5.22476 5.47905 5.04093 2.95516 5.97054 0.848179C4.84491 0.968503 3.72768 1.37162 2.74781 2.08719C-0.224105 4.25747 -0.874706 8.43084 1.29558 11.4028C3.46586 14.3747 7.63923 15.0253 10.6111 12.855Z"
        ></path>
      </svg>
    </span>
  </label>
</div>

<script is:inline>
  (function () {
    function setupTheme() {
      // Seleccionamos TODOS los inputs de toggle en la página
      const toggles = document.querySelectorAll(".theme-toggle-input");
      const html = document.documentElement;

      // 1. Obtener Preferencia Actual
      const getTheme = () => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          return "dark";
        }
        return "light";
      };

      // 2. Aplicar Estado Visual a HTML y a TODOS los toggles
      const updateTheme = (theme) => {
        if (theme === "dark") {
          html.classList.add("dark");
          toggles.forEach((t) => (t.checked = true));
        } else {
          html.classList.remove("dark");
          toggles.forEach((t) => (t.checked = false));
        }
        localStorage.setItem("theme", theme);
      };

      // Inicializar inmediatamente
      updateTheme(getTheme());

      // 3. Escuchar Eventos en TODOS los toggles
      toggles.forEach((toggle) => {
        // Removemos listeners anteriores para evitar duplicados si se re-ejecuta
        const newToggle = toggle.cloneNode(true);
        toggle.parentNode.replaceChild(newToggle, toggle);

        newToggle.addEventListener("change", (e) => {
          const newTheme = e.target.checked ? "dark" : "light";
          updateTheme(newTheme);
        });
      });
    }

    // Ejecutar Setup
    setupTheme();
    document.addEventListener("astro:after-swap", setupTheme);
  })();
</script>
